<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JapLingua-Learning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/wanakana@5.0.1/wanakana.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script>
    window.chtlConfig = {
      chatbotId: "7958299315"
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

    .kanji-font {
      font-family: 'Noto Sans JP', sans-serif;
    }

    @keyframes petalFall {
      0% {
        transform: translateY(-10%) rotate(0deg);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      100% {
        transform: translateY(120%) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes gentlePulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.06);
      }
    }

    /* KanjiOCR specific styles */
    .ocr-processing-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Workflow transition animations */
    .workflow-fade-in {
      animation: workflowFadeIn 0.5s ease-out forwards;
    }

    .workflow-fade-out {
      animation: workflowFadeOut 0.3s ease-in forwards;
    }

    @keyframes workflowFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes workflowFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Crop interface styles */
    #cropContainer {
      position: relative;
      display: inline-block;
      user-select: none;
      max-width: 100%;
    }

    #cropOverlay {
      background: transparent;
      pointer-events: none;
    }

    #cropBox {
      min-width: 50px;
      min-height: 50px;
      pointer-events: auto;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      border: 2px solid rgb(59 130 246);
      background: rgba(59, 130, 246, 0.1);
    }

    #cropBox>div {
      border-radius: 50%;
      pointer-events: auto;
      z-index: 10;
      background: white;
      border: 2px solid rgb(59 130 246);
      transition: all 0.2s ease;
    }

    #cropBox:hover {
      border-color: rgb(37 99 235);
    }

    #cropBox>div:hover {
      background: rgb(59 130 246);
    }

    /* Mobile-friendly resize handles */
    @media (max-width: 768px) {
      #cropBox>div {
        width: 20px !important;
        height: 20px !important;
        margin: -10px 0 0 -10px;
      }
      
      #cropBox>div[data-handle="nw"] { top: -10px !important; left: -10px !important; }
      #cropBox>div[data-handle="n"] { top: -10px !important; left: 50% !important; transform: translateX(-50%) !important; }
      #cropBox>div[data-handle="ne"] { top: -10px !important; right: -10px !important; }
      #cropBox>div[data-handle="e"] { top: 50% !important; right: -10px !important; transform: translateY(-50%) !important; }
      #cropBox>div[data-handle="se"] { bottom: -10px !important; right: -10px !important; }
      #cropBox>div[data-handle="s"] { bottom: -10px !important; left: 50% !important; transform: translateX(-50%) !important; }
      #cropBox>div[data-handle="sw"] { bottom: -10px !important; left: -10px !important; }
      #cropBox>div[data-handle="w"] { top: 50% !important; left: -10px !important; transform: translateY(-50%) !important; }
    }

    /* Camera interface styles */
    #cameraVideo {
      transform: scaleX(-1);
      /* Mirror effect for front camera */
    }

    /* Progress step styles */
    .step-active {
      background-color: rgb(37 99 235) !important;
      color: white !important;
    }

    .step-completed {
      background-color: rgb(34 197 94) !important;
      color: white !important;
    }

    .sakura-petal {
      position: absolute;
      width: 10px;
      height: 14px;
      background: linear-gradient(135deg, #fecdd3, #fda4af);
      border-radius: 60% 40% 60% 40%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      opacity: 0;
    }

    .loader-torii {
      animation: gentlePulse 1.6s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200px 0;
      }

      100% {
        background-position: calc(200px + 100%) 0;
      }
    }

    #loadingScreen {
      animation: fadeInUp 0.8s ease-out;
    }

    #loadingScreen h1 {
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    #loadingScreen p {
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    #progressBar {
      background: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6, #ec4899);
      background-size: 200px 100%;
      animation: shimmer 2s infinite linear;
    }

    .sakura-petal {
      animation: petalFall 4s linear infinite;
    }

    /* Japanese-themed falling leaves animation for white backgrounds */
    .bg-white {
      position: relative;
      overflow: hidden;
    }

    .bg-white::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 15% 25%, rgba(139, 69, 19, 0.08) 1px, transparent 1px),
        radial-gradient(circle at 75% 45%, rgba(160, 82, 45, 0.06) 1px, transparent 1px),
        radial-gradient(circle at 35% 75%, rgba(205, 133, 63, 0.07) 1px, transparent 1px),
        radial-gradient(circle at 85% 15%, rgba(222, 184, 135, 0.05) 1px, transparent 1px);
      background-size: 180px 180px, 220px 220px, 160px 160px, 200px 200px;
      animation: leafDrift 25s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    .bg-white::after {
      content: '🍂';
      position: absolute;
      top: -30px;
      left: 20%;
      font-size: 16px;
      opacity: 0.25;
      animation: leafFall 12s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    /* Additional falling leaves container */
    .falling-leaves {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .leaf {
      position: absolute;
      top: -50px;
      font-size: 14px;
      opacity: 0.2;
      animation: leafFall 15s linear infinite;
    }

    .leaf:nth-child(1) {
      animation-delay: 0s;
      animation-duration: 18s;
    }

    .leaf:nth-child(2) {
      animation-delay: 3s;
      animation-duration: 16s;
    }

    .leaf:nth-child(3) {
      animation-delay: 1s;
      animation-duration: 20s;
    }

    .leaf:nth-child(4) {
      animation-delay: 4s;
      animation-duration: 17s;
    }

    .leaf:nth-child(5) {
      animation-delay: 2s;
      animation-duration: 19s;
    }

    .leaf:nth-child(6) {
      animation-delay: 5s;
      animation-duration: 15s;
    }

    .leaf:nth-child(7) {
      animation-delay: 7s;
      animation-duration: 21s;
    }

    .leaf:nth-child(8) {
      animation-delay: 6s;
      animation-duration: 14s;
    }

    /* Ensure content stays above background animations */
    .bg-white>* {
      position: relative;
      z-index: 1;
    }

    @keyframes leafFall {
      0% {
        transform: translateY(-50px) translateX(0px) rotate(0deg);
        opacity: 0;
      }

      10% {
        opacity: 0.25;
      }

      25% {
        transform: translateY(25vh) translateX(20px) rotate(180deg);
        opacity: 0.2;
      }

      50% {
        transform: translateY(50vh) translateX(-15px) rotate(360deg);
        opacity: 0.15;
      }

      75% {
        transform: translateY(75vh) translateX(25px) rotate(540deg);
        opacity: 0.1;
      }

      90% {
        opacity: 0.05;
      }

      100% {
        transform: translateY(calc(100vh + 50px)) translateX(-10px) rotate(720deg);
        opacity: 0;
      }
    }

    @keyframes leafDrift {

      0%,
      100% {
        transform: translateX(0px) translateY(0px);
      }

      25% {
        transform: translateX(15px) translateY(-8px);
      }

      50% {
        transform: translateX(-10px) translateY(5px);
      }

      75% {
        transform: translateX(12px) translateY(-3px);
      }
    }
  </style>
</head>

<body>
  <!-- Falling Leaves Background Animation -->
  <div class="falling-leaves">
    <div class="leaf" style="left: 10%; animation-delay: 0s;">🍂</div>
    <div class="leaf" style="left: 25%; animation-delay: 3s;">🍁</div>
    <div class="leaf" style="left: 45%; animation-delay: 1s;">🍂</div>
    <div class="leaf" style="left: 65%; animation-delay: 4s;">🍁</div>
    <div class="leaf" style="left: 80%; animation-delay: 2s;">🍂</div>
    <div class="leaf" style="left: 35%; animation-delay: 5s;">🍁</div>
    <div class="leaf" style="left: 55%; animation-delay: 7s;">🍂</div>
    <div class="leaf" style="left: 75%; animation-delay: 6s;">🍁</div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen"
    class="fixed inset-0 bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center z-50">
    <div class="text-center">
      <!-- Animated Torii Gate -->
      <div class="relative mb-8">
        <svg class="w-24 h-24 mx-auto text-white animate-pulse" viewBox="0 0 64 64" fill="currentColor">
          <rect x="6" y="10" width="52" height="6" rx="2"></rect>
          <rect x="10" y="18" width="44" height="4" rx="2"></rect>
          <rect x="14" y="22" width="6" height="32" rx="1"></rect>
          <rect x="44" y="22" width="6" height="32" rx="1"></rect>
          <rect x="20" y="30" width="4" height="24" rx="1"></rect>
          <rect x="40" y="30" width="4" height="24" rx="1"></rect>
        </svg>

        <!-- Floating Sakura Petals -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
          <div class="sakura-petal" style="left: 10%; animation-delay: 0s;"></div>
          <div class="sakura-petal" style="left: 20%; animation-delay: 0.5s;"></div>
          <div class="sakura-petal" style="left: 30%; animation-delay: 1s;"></div>
          <div class="sakura-petal" style="left: 40%; animation-delay: 1.5s;"></div>
          <div class="sakura-petal" style="left: 50%; animation-delay: 2s;"></div>
          <div class="sakura-petal" style="left: 60%; animation-delay: 0.3s;"></div>
          <div class="sakura-petal" style="left: 70%; animation-delay: 0.8s;"></div>
          <div class="sakura-petal" style="left: 80%; animation-delay: 1.3s;"></div>
          <div class="sakura-petal" style="left: 90%; animation-delay: 1.8s;"></div>
        </div>
      </div>

      <!-- App Title -->
      <h1 class="text-4xl font-bold text-white mb-4">JapLingua</h1>
      <p class="text-xl text-indigo-200 mb-8">Learning Hub</p>

      <!-- Loading Animation -->
      <div class="flex items-center justify-center space-x-2 mb-6">
        <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
        <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
        <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
      </div>

      <!-- Loading Text -->
      <p class="text-indigo-300 text-lg" id="loadingText">Initializing...</p>

      <!-- Progress Bar -->
      <div class="w-64 h-2 bg-indigo-800 rounded-full mx-auto mt-4 overflow-hidden">
        <div id="progressBar"
          class="h-full bg-gradient-to-r from-pink-400 to-indigo-400 rounded-full transition-all duration-300 ease-out"
          style="width: 0%;"></div>
      </div>
    </div>
  </div>

  <div class="min-h-screen bg-gray-50 font-sans text-gray-800 antialiased p-4">
    <div class="container mx-auto max-w-4xl py-8">
      <header class="text-center mb-12">
        <h1 class="text-5xl font-extrabold text-indigo-600 mb-2">Japanese Learning Hub</h1>
        <p class="text-lg text-gray-500">Your practice for Hiragana, Katakana, and translation.</p>
        <div style="font-family: monospace; font-size: 2rem; font-weight: bold;" class="mt-2">
          <span id="typewriterText"></span>
          <span class="type-cursor"></span>
        </div>
        <style>
          @keyframes blink {

            0%,
            50% {
              opacity: 1;
            }

            50.1%,
            100% {
              opacity: 0;
            }
          }

          .type-cursor {
            display: inline-block;
            width: 0.1em;
            background-color: black;
            margin-left: 2px;
            animation: blink 1s steps(1) infinite;
          }
        </style>
        <nav class="mt-8 flex flex-wrap justify-center gap-2 sm:gap-3">
          <button id="btnNavHome" aria-label="Home" title="Home"
            class="p-2.5 rounded-full transition-colors duration-300 bg-indigo-600 text-white shadow-lg hover:bg-indigo-700">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
              <path
                d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 1-1.06 1.06l-.81-.81V20a2 2 0 0 1-2 2h-3.25a.75.75 0 0 1-.75-.75V16a1.5 1.5 0 0 0-1.5-1.5h-1.5A1.5 1.5 0 0 0 9.75 16v5.25c0 .414-.336.75-.75.75H5.75A2 2 0 0 1 3.75 20v-7.22l-.81.81a.75.75 0 0 1-1.06-1.06l8.59-8.69z" />
            </svg>
          </button>
          <button id="btnNavFlashcards"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            Flashcards
          </button>
          <button id="btnNavTranslator"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            Translator
          </button>
          <button id="btnNavKanjiOCR"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            KanjiOCR
          </button>
          <button id="btnNavPronunciation"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            Pronunciation
          </button>
          <button id="btnNavPhrases"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            Phrases
          </button>
          <button id="btnNavFacts"
            class="px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100 text-sm sm:text-base">
            Facts
          </button>
        </nav>
      </header>

      <main class="min-h-[500px] flex items-center justify-center bg-gray-200 rounded-2xl shadow-inner p-6">
        <div class="flex flex-col items-center w-full space-y-6">
          <!-- Home / Landing Section -->
          <section id="homeSection" class="w-full">
            <div
              class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-50 via-white to-pink-50 ring-1 ring-indigo-100 shadow-md">
              <div class="grid md:grid-cols-2 gap-6 p-6">
                <div class="flex flex-col justify-center">
                  <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-700">Discover <span
                      class="whitespace-nowrap">日本文化</span></h2>
                  <p class="mt-3 text-gray-600 leading-relaxed">
                    Welcome to Japanese Learning Hub — a cozy place to practice
                    Hiragana, Katakana, and explore the rich world of Japan.
                    Start with flashcards, try translations, and read about
                    culture, traditions, and etiquette below.
                  </p>
                  <div class="mt-5 flex flex-wrap gap-2">
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700">Punctuality</span>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-700">Loyalty</span>
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Harmony</span>
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">Respect</span>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <img alt="Torii gate at sunset" class="h-36 w-full object-cover rounded-xl shadow"
                    src="https://res.cloudinary.com/jnto/image/upload/w_600,h_600,c_fill,f_auto,fl_lossy,q_60/v1/media/filer_public/2c/21/2c21ab18-f213-4bfa-adb8-b37b1620f7da/shutterstock_302738093-1024x683_grbcxu" />
                  <img alt="Traditional tea set" class="h-36 w-full object-cover rounded-xl shadow"
                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTrz4cb70WgaJhjudywvjirjuM7elPftnaod-xRTXMl37RyaoJWCAcQUzQv-4qMtNn8zqU&usqp=CAU" />
                  <img alt="Cherry blossoms in bloom" class="h-36 w-full object-cover rounded-xl shadow"
                    src="https://npr.brightspotcdn.com/dims3/default/strip/false/crop/4032x3024+0+0/resize/4032x3024!/?url=http%3A%2F%2Fnpr-brightspot.s3.amazonaws.com%2Fe8%2F49%2F4568ec1344e4adaaeea7560e8ceb%2Fimg-8535.jpg" />
                  <img alt="City lights in Tokyo" class="h-36 w-full object-cover rounded-xl shadow"
                    src="https://media-cdn.tripadvisor.com/media/attractions-splice-spp-674x446/13/d1/d9/04.jpg" />
                </div>
              </div>
            </div>
            <div class="mt-6 grid md:grid-cols-3 gap-4">
              <div class="bg-white rounded-xl p-5 shadow ring-1 ring-indigo-50">
                <h3 class="text-lg font-semibold text-indigo-700">Culture</h3>
                <p class="mt-2 text-sm text-gray-600">From anime and manga to tea ceremony, samurai, festivals,
                  calligraphy, and sushi, Japan blends timeless tradition with modern creativity.</p>
              </div>
              <div class="bg-white rounded-xl p-5 shadow ring-1 ring-indigo-50">
                <h3 class="text-lg font-semibold text-indigo-700">Traditions</h3>
                <p class="mt-2 text-sm text-gray-600">Seasonal festivals, shrine visits, hanami (flower viewing), tea
                  gatherings, and New Year rituals celebrate nature and community.</p>
              </div>
              <div class="bg-white rounded-xl p-5 shadow ring-1 ring-indigo-50">
                <h3 class="text-lg font-semibold text-indigo-700">Etiquette</h3>
                <p class="mt-2 text-sm text-gray-600">Bow politely, remove shoes indoors, queue neatly, offer gifts
                  thoughtfully, and speak with respect: いただきます, ありがとうございます.</p>
              </div>
            </div>
            <div class="mt-6 bg-white rounded-xl p-6 shadow ring-1 ring-indigo-50">
              <h3 class="text-xl font-bold text-indigo-700">About this project</h3>
              <p class="mt-2 text-gray-600">Konnichiwa, enthusiasts! ✨ This is my small effort made out of interest in
                Japanese, and I truly hope you like it. The app is here to help you learn kana through interactive
                flashcards and explore words with the translator. It’s meant to feel calm, welcoming, and enjoyable for
                anyone curious about Japanese.
              </p>
            </div>
          </section>
          <!-- Create Section -->
          <div id="createSection" class="w-full max-w-sm bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="mb-3">
              <h2 class="text-xl font-bold text-indigo-700">Kana Flashcards</h2>
              <p class="text-sm text-gray-600 mt-1">Build a quick deck to practice Hiragana or Katakana. Flip to reveal
                the answer and track your progress.</p>
            </div>
            <div class="mb-4 grid grid-cols-1 gap-2">
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-indigo-50/60 rounded-lg p-2 ring-1 ring-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-indigo-600 mt-0.5">
                  <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z" />
                </svg>
                <span>Tip: Click <span class="font-semibold">Create Flashcards</span>, choose a script, then
                  practice.</span>
              </div>
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-emerald-50/60 rounded-lg p-2 ring-1 ring-emerald-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-emerald-600 mt-0.5">
                  <path
                    d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-1 15-4-4 1.41-1.41L11 13.17l5.59-5.58L18 9Z" />
                </svg>
                <span>Use <span class="font-semibold">Show Answer</span> to flip the card, then move to the next.</span>
              </div>
            </div>
            <label for="numInput" class="block text-sm font-medium text-gray-600 mb-2">Number of flashcards</label>
            <input id="numInput" type="number" min="1" class="w-full border-2 border-gray-300 rounded-lg p-2 mb-4"
              placeholder="e.g. 20" />
            <button id="createBtn"
              class="w-full px-4 py-2 rounded-lg font-semibold transition-colors duration-300 bg-indigo-600 text-white hover:bg-indigo-700">Create
              Flashcards</button>
          </div>

          <!-- Options Section (vertical buttons) -->
          <div id="optionsPanel" class="w-full max-w-sm hidden">
            <div class="flex flex-col space-y-3">
              <button id="btnHiragana"
                class="w-full px-4 py-2 rounded-full font-medium transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100">Hiragana
                → Romanji</button>
              <button id="btnKatakana"
                class="w-full px-4 py-2 rounded-full font-medium transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100">Katakana
                → Romanji</button>
              <button id="btnCharToRomaji"
                class="w-full px-4 py-2 rounded-full font-medium transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100">Romanji
                → Katakana</button>
              <button id="btnRomajiToChar"
                class="w-full px-4 py-2 rounded-full font-medium transition-colors duration-300 bg-white text-gray-800 hover:bg-gray-100">Romaji
                → Hiragana</button>
            </div>
          </div>

          <!-- Card Area -->
          <div id="cardArea" class="flex flex-col items-center justify-center space-y-8 h-full hidden">
            <div class="relative">
              <div class="w-80 h-96 [perspective:1000px]">
                <div id="flashcard"
                  class="relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d]">
                  <div
                    class="absolute inset-0 w-full h-full bg-white rounded-xl shadow-lg flex items-center justify-center [backface-visibility:hidden]">
                    <span id="frontText" class="text-8xl font-bold text-gray-800 select-none">あ</span>
                  </div>
                  <div
                    class="absolute inset-0 w-full h-full bg-indigo-500 rounded-xl shadow-lg flex items-center justify-center [transform:rotateY(180deg)] [backface-visibility:hidden]">
                    <span id="backText" class="text-5xl font-bold text-white select-none">a</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
              <button id="flipBtn"
                class="px-6 py-3 bg-purple-500 text-white font-semibold rounded-full shadow-lg hover:bg-purple-600 transition duration-300 transform hover:scale-105">Show
                Answer</button>
              <button id="nextBtn"
                class="px-6 py-3 bg-green-500 text-white font-semibold rounded-full shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105">Next
                Card</button>
              <button id="resetBtn"
                class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-700 transition duration-300 transform hover:scale-105 hidden">Reset</button>
            </div>
            <div id="countText" class="text-sm text-gray-500 mt-4">Card 1 of 10</div>
          </div>

          <!-- Session Complete -->
          <div id="sessionComplete" class="flex flex-col items-center justify-center space-y-6 hidden">
            <h2 class="text-4xl font-bold text-gray-800">Session Complete!</h2>
            <p class="text-lg text-gray-600 text-center max-w-sm">You've gone through all the characters. Great job!</p>
            <button id="restartBtn"
              class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">Start
              New Session</button>
          </div>

          <!-- Translator -->
          <div id="translatorSection" class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="mb-3">
              <h2 class="text-xl font-bold text-indigo-700">Smart Translator</h2>
              <p class="text-sm text-gray-600 mt-1">Select the input type (Japanese, Romaji, or English), enter your
                text, and click on the output to see the corresponding result.</p>
            </div>
            <div class="mb-3 flex items-center space-x-3">
              <label for="inputType" class="text-sm font-medium text-gray-600">Input Type</label>
              <select id="inputType" class="border-2 border-gray-300 rounded-lg p-2 text-sm">
                <option value="japanese">Japanese</option>
                <option value="romanji">Romanji</option>
                <option value="english">English</option>
              </select>
            </div>
            <textarea id="inputText"
              class="w-full h-32 p-4 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors"
              placeholder="Type Japanese text..."></textarea>
            <div class="mt-4 flex items-center justify-end">
              <button id="translateBtn"
                class="px-5 py-2 rounded-lg font-semibold bg-indigo-600 text-white hover:bg-indigo-700">Translate</button>
            </div>
            <div class="mt-3 grid grid-cols-1 gap-2">
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-indigo-50/60 rounded-lg p-2 ring-1 ring-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-indigo-600 mt-0.5">
                  <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z" />
                </svg>
                <span>Press <span class="font-semibold">Enter</span> to translate quickly.</span>
              </div>
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-blue-50/60 rounded-lg p-2 ring-1 ring-blue-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-blue-600 mt-0.5">
                  <path d="M3 5h18v2H3zm4 6h10v2H7zm-4 6h18v2H3z" />
                </svg>
                <span>Outputs include <span class="font-semibold">Romanji</span> and <span
                    class="font-semibold">English</span> where applicable.</span>
              </div>
            </div>
            <div id="outputText"
              class="mt-4 bg-blue-50 rounded-xl ring-1 ring-blue-200 p-6 min-h-[100px] text-blue-900 font-medium hidden relative overflow-hidden">
            </div>
          </div>

          <!-- Pronunciation Section -->
          <div id="pronunciationSection" class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="mb-3">
              <h2 class="text-xl font-bold text-indigo-700">Pronunciation Practice</h2>
              <p class="text-sm text-gray-600 mt-1">Type Romanji text and hear the Japanese pronunciation. Perfect for
                learning proper pronunciation.</p>
            </div>
            <div class="mb-4 grid grid-cols-1 gap-2">
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-indigo-50/60 rounded-lg p-2 ring-1 ring-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-indigo-600 mt-0.5">
                  <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z" />
                </svg>
                <span>Type Romanji like <span class="font-semibold">"konnichiwa"</span> and click <span
                    class="font-semibold">Speak</span> to hear it.</span>
              </div>
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-emerald-50/60 rounded-lg p-2 ring-1 ring-emerald-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-emerald-600 mt-0.5">
                  <path
                    d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm6 16H8a1 1 0 0 1-1-1V9h10v12a1 1 0 0 1-1 1z" />
                  <circle cx="12" cy="15" r="2" />
                </svg>
                <span>The text is automatically converted to <span class="font-semibold">Hiragana</span> for accurate
                  pronunciation.</span>
              </div>
              <div
                class="flex items-start space-x-2 text-xs text-gray-600 bg-yellow-50/60 rounded-lg p-2 ring-1 ring-yellow-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-4 h-4 text-yellow-600 mt-0.5">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
                <span><span class="font-semibold">Troubleshooting:</span> If pronunciation doesn't work, check browser
                  settings or use "Test Voices" to see available options.</span>
              </div>
            </div>
            <div class="space-y-4">
              <div>
                <label for="romanjiInput" class="block text-sm font-medium text-gray-600 mb-2">Romanji Text</label>
                <input type="text" id="romanjiInput"
                  class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors"
                  placeholder="e.g. konnichiwa, arigatou, sayonara" />
              </div>
              <div class="flex items-center justify-between">
                <button id="speakBtn"
                  class="px-6 py-3 bg-purple-500 text-white font-semibold rounded-full shadow-lg hover:bg-purple-600 transition duration-300 transform hover:scale-105 flex items-center space-x-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path
                      d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.318 1.5v6c0 .836 1.177 1.5 2.318 1.5H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0 11.5 11.5 0 010 16.268.75.75 0 11-1.06-1.06 10 10 0 000-14.147.75.75 0 010-1.061z" />
                    <path
                      d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" />
                  </svg>
                  <span>Speak</span>
                </button>
                <div id="pronunciationStatus" class="text-sm text-gray-500"></div>
                <button id="testVoicesBtn"
                  class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600 transition-colors">
                  Test Voices
                </button>
              </div>
              <div id="japaneseOutput"
                class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl ring-1 ring-indigo-200 p-6 min-h-[80px] hidden">
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-2">Japanese:</p>
                  <p id="japaneseText" class="text-3xl font-bold text-indigo-700"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Phrases Section -->
          <div id="phrasesSection" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-indigo-700">Japanese Phrases & Words</h2>
              <p class="text-sm text-gray-600 mt-1">Explore essential Japanese phrases and vocabulary with romanji and
                English translations.</p>
            </div>


            <div class="mb-6 flex flex-wrap gap-2">
              <button id="showAllBtn"
                class="px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-medium hover:bg-indigo-700 transition-colors">
                All
              </button>
              <button id="showPhrasesBtn"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300 transition-colors">
                Phrases
              </button>
              <button id="showWordsBtn"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300 transition-colors">
                Words
              </button>
            </div>

            <div class="mb-4">
              <input type="text" id="searchInput" placeholder="Search phrases or words..."
                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors">
            </div>

            <div id="phrasesContainer" class="space-y-3 max-h-96 overflow-y-auto">
              <div class="text-center py-8 text-gray-500">
                <div
                  class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-2">
                </div>
                Loading phrases...
              </div>
            </div>

            <div id="phrasesStats" class="mt-4 text-sm text-gray-500 text-center hidden">
              Showing <span id="currentCount">0</span> of <span id="totalCount">0</span> items
            </div>
          </div>

          <!-- KanjiOCR Section -->
          <div id="kanjiOCRSection" class="w-full max-w-6xl hidden">
            <!-- Header -->
            <div class="bg-white shadow-sm border-b border-slate-200 rounded-t-xl mb-8">
              <div class="px-4 py-6">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-3 rounded-xl shadow-lg">
                      <i class="fas fa-language text-white text-xl"></i>
                    </div>
                    <div>
                      <h1 class="text-2xl font-bold text-gray-900">Kanji Extractor</h1>
                      <p class="text-gray-600 text-sm">Extract and analyze Japanese characters with AI-powered OCR</p>
                    </div>
                  </div>
                  <!-- Progress Breadcrumbs -->
                  <div id="workflowProgress" class="hidden">
                    <div class="flex items-center space-x-2 text-sm">
                      <span id="step1" class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium">1.
                        Input</span>
                      <i class="fas fa-chevron-right text-gray-400"></i>
                      <span id="step2" class="px-3 py-1 rounded-full bg-gray-100 text-gray-500">2. Process</span>
                      <i class="fas fa-chevron-right text-gray-400"></i>
                      <span id="step3" class="px-3 py-1 rounded-full bg-gray-100 text-gray-500">3. Analyze</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Messages container for alerts -->
            <div id="messages" class="mb-6"></div>

            <!-- Image Selection Interface -->
            <div id="imageSelectionInterface" class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 mb-8">
              <div class="text-left">
                <div class="mb-8">
                  <div class="flex items-center mb-4">
                    <div
                      class="w-20 h-20 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mr-4">
                      <i class="fas fa-language text-3xl text-blue-600"></i>
                    </div>
                    <div>
                      <h2 class="text-2xl font-semibold text-gray-900 mb-2">Input Japanese Text</h2>
                      <p class="text-gray-600">Upload an image, capture a photo, or directly type Japanese text</p>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                  <!-- Upload Option -->
                  <div class="relative group">
                    <input type="file" id="imageInput" accept="image/jpeg,image/png,image/webp" class="hidden">
                    <label for="imageInput"
                      class="cursor-pointer flex flex-col items-center justify-center p-8 bg-gradient-to-br from-slate-50 to-blue-50 hover:from-blue-50 hover:to-indigo-50 border-2 border-dashed border-slate-300 hover:border-blue-400 rounded-xl transition-all duration-300 group-hover:shadow-lg min-h-48">
                      <div
                        class="w-16 h-16 bg-gradient-to-r from-slate-100 to-blue-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-cloud-upload-alt text-2xl text-blue-600"></i>
                      </div>
                      <h3 class="text-lg font-semibold text-gray-900 mb-2">Upload Image</h3>
                      <p class="text-sm text-gray-600">Choose from your device gallery or files</p>
                      <p class="text-xs text-gray-500 mt-2">JPG, PNG, WebP • Max 5MB</p>
                    </label>
                  </div>

                  <!-- Camera Option -->
                  <div class="relative group">
                    <button type="button" id="cameraBtn"
                      class="w-full flex flex-col items-center justify-center p-8 bg-gradient-to-br from-slate-50 to-purple-50 hover:from-purple-50 hover:to-indigo-50 border-2 border-dashed border-slate-300 hover:border-purple-400 rounded-xl transition-all duration-300 group-hover:shadow-lg min-h-48">
                      <div
                        class="w-16 h-16 bg-gradient-to-r from-slate-100 to-purple-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-camera text-2xl text-purple-600"></i>
                      </div>
                      <h3 class="text-lg font-semibold text-gray-900 mb-2">Capture Photo</h3>
                      <p class="text-sm text-gray-600">Take a new photo with your camera</p>
                      <p class="text-xs text-gray-500 mt-2">Perfect for books, signs, documents</p>
                    </button>
                  </div>

                  <!-- Text Input Option -->
                  <div class="relative group">
                    <div
                      class="w-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-slate-50 to-green-50 hover:from-green-50 hover:to-emerald-50 border-2 border-dashed border-slate-300 hover:border-green-400 rounded-xl transition-all duration-300 group-hover:shadow-lg min-h-48">
                      <div
                        class="w-16 h-16 bg-gradient-to-r from-slate-100 to-green-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-keyboard text-2xl text-green-600"></i>
                      </div>
                      <h3 class="text-lg font-semibold text-gray-900 mb-3">Type Text</h3>
                      <textarea id="textInput" placeholder="Type or paste Japanese text here..."
                        class="w-full h-20 p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 resize-none kanji-font"
                        style="font-size: 16px;"></textarea>
                      <button id="processTextBtn"
                        class="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Process Text
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Instructions -->
                <div class="mt-8 max-w-4xl mx-auto">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                      <div class="flex items-start space-x-3">
                        <i class="fas fa-camera text-blue-600 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                          <p class="font-medium mb-1">Image/Camera Tips:</p>
                          <ul class="list-disc list-inside space-y-1 text-blue-700">
                            <li>Ensure good lighting and clear text visibility</li>
                            <li>Keep the camera steady and text in focus</li>
                            <li>You'll be able to crop and adjust before processing</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                      <div class="flex items-start space-x-3">
                        <i class="fas fa-keyboard text-green-600 mt-0.5"></i>
                        <div class="text-sm text-green-800">
                          <p class="font-medium mb-1">Text Input Tips:</p>
                          <ul class="list-disc list-inside space-y-1 text-green-700">
                            <li>Type or paste Japanese text directly</li>
                            <li>Supports hiragana, katakana, and kanji</li>
                            <li>Perfect for analyzing text from websites or documents</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Camera Interface -->
            <div id="cameraInterface" class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 mb-8 hidden">
              <div class="text-left mb-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Camera Capture</h3>
                <p class="text-gray-600">Position your camera to capture the Japanese text</p>
              </div>

              <div class="relative max-w-2xl mx-auto">
                <video id="cameraVideo" class="w-full rounded-lg shadow-lg" autoplay playsinline></video>
                <canvas id="cameraCanvas" class="hidden"></canvas>

                <div class="flex justify-center space-x-4 mt-6">
                  <button id="capturePhotoBtn"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg transition-colors">
                    <i class="fas fa-camera mr-2"></i>
                    Capture Photo
                  </button>
                  <button id="cancelCameraBtn"
                    class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Image Cropping Interface -->
            <div id="croppingInterface" class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 mb-8 hidden">
              <div class="text-left mb-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Crop Your Image</h3>
                <p class="text-gray-600">Adjust the selection to focus on the text you want to extract</p>
              </div>

              <div class="max-w-4xl mx-auto">
                <div class="relative bg-gray-100 rounded-lg overflow-hidden" id="cropContainer">
                  <img id="cropImage" class="max-w-full h-auto" style="max-height: 500px;">
                  <div id="cropOverlay" class="absolute inset-0">
                    <div id="cropBox" class="absolute cursor-move">
                      <!-- Resize handles -->
                      <div class="absolute -top-2 -left-2 w-4 h-4 cursor-nw-resize" data-handle="nw"></div>
                      <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 cursor-n-resize"
                        data-handle="n"></div>
                      <div class="absolute -top-2 -right-2 w-4 h-4 cursor-ne-resize" data-handle="ne"></div>
                      <div class="absolute top-1/2 -right-2 transform -translate-y-1/2 w-4 h-4 cursor-e-resize"
                        data-handle="e"></div>
                      <div class="absolute -bottom-2 -right-2 w-4 h-4 cursor-se-resize" data-handle="se"></div>
                      <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 cursor-s-resize"
                        data-handle="s"></div>
                      <div class="absolute -bottom-2 -left-2 w-4 h-4 cursor-sw-resize" data-handle="sw"></div>
                      <div class="absolute top-1/2 -left-2 transform -translate-y-1/2 w-4 h-4 cursor-w-resize"
                        data-handle="w"></div>
                    </div>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 mt-6">
                  <button id="confirmCropBtn"
                    class="w-full sm:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>
                    Confirm Crop
                  </button>
                  <button id="cancelCropBtn"
                    class="w-full sm:w-auto px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                  </button>
                  <button id="resetCropBtn"
                    class="w-full sm:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg transition-colors">
                    <i class="fas fa-undo mr-2"></i>
                    Reset Selection
                  </button>
                </div>

                <!-- Crop Instructions -->
                <div class="mt-4 bg-blue-50 rounded-lg p-4 border border-blue-200">
                  <div class="flex items-start space-x-3">
                    <i class="fas fa-hand-pointer text-blue-600 mt-0.5"></i>
                    <div class="text-sm text-blue-800">
                      <p class="font-medium mb-1">How to crop:</p>
                      <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Drag the selection box to move it around</li>
                        <li>Drag the corner and edge handles to resize (larger handles on mobile)</li>
                        <li>Make sure to include all the text you want to extract</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Processing Interface -->
            <div id="processingInterface"
              class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 mb-8 hidden">
              <div class="text-left">
                <div class="flex items-center mb-6">
                  <div
                    class="w-16 h-16 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-cog fa-spin text-2xl text-blue-600"></i>
                  </div>
                  <div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Processing Image</h3>
                    <p class="text-gray-600">Extracting text using AI-powered OCR...</p>
                  </div>
                </div>
                <div class="max-w-md mx-auto">
                  <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="processingProgress"
                      class="bg-gradient-to-r from-blue-600 to-indigo-600 h-2 rounded-full transition-all duration-300"
                      style="width: 0%"></div>
                  </div>
                  <p id="processingStatus" class="text-sm text-gray-500 mt-2">Initializing...</p>
                </div>
              </div>
            </div>

            <!-- Results Section -->
            <div id="resultsInterface" class="space-y-6 hidden">
              <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Extraction Results</h3>
                <button id="newImageBtn"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                  <i class="fas fa-plus mr-2"></i>
                  Change Input
                </button>
              </div>
              <div id="output" class="space-y-6"></div>
            </div>
          </div>

          <div id="factsSection" class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="mb-8 text-center">
              <h2 class="text-3xl font-bold text-indigo-700 mb-2">Fascinating Japan Facts</h2>
              <p class="text-lg text-gray-600">Discover the amazing culture, traditions, and unique aspects of Japan</p>
            </div>

            <!-- Category Filter -->
            <div class="mb-8 flex flex-wrap justify-center gap-3">
              <button id="allFactsBtn"
                class="px-6 py-2 bg-indigo-600 text-white rounded-full font-medium hover:bg-indigo-700 transition-colors">
                All Facts
              </button>
              <button id="geographyBtn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
                Geography & Nature
              </button>
              <button id="dailyLifeBtn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
                Daily Life & Tech
              </button>
              <button id="cultureBtn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
                Culture & Customs
              </button>
              <button id="traditionsBtn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
                Unique Traditions
              </button>
            </div>

            <!-- Facts Container -->
            <div id="factsContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              <!-- Geography & Nature Facts -->
              <div
                class="fact-card geography bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-xl border border-green-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                      <path fill-rule="evenodd"
                        d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-green-800">Island Nation</h3>
                </div>
                <p class="text-green-700">Japan consists of over 6,800 islands! While most people know the four main
                  islands (Honshu, Hokkaido, Kyushu, and Shikoku), many smaller ones remain uninhabited.</p>
              </div>

              <div
                class="fact-card geography bg-gradient-to-br from-amber-50 to-orange-100 p-6 rounded-xl border border-amber-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-amber-800">Mountainous Land</h3>
                </div>
                <p class="text-amber-700">About 70% of Japan is mountainous and forested, which means the population is
                  highly concentrated in coastal areas. This creates some of the world's most densely populated cities.
                </p>
              </div>

              <div
                class="fact-card geography bg-gradient-to-br from-red-50 to-pink-100 p-6 rounded-xl border border-red-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-red-800">Ring of Fire</h3>
                </div>
                <p class="text-red-700">Japan experiences over 1,500 earthquakes per year due to its location on the
                  Pacific Ring of Fire. It also has many active volcanoes, making it one of the most seismically active
                  countries.</p>
              </div>

              <!-- Daily Life & Technology Facts -->
              <div
                class="fact-card daily-life bg-gradient-to-br from-blue-50 to-cyan-100 p-6 rounded-xl border border-blue-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-blue-800">Vending Machine Capital</h3>
                </div>
                <p class="text-blue-700">Japan has one vending machine for every 24 people! You can buy everything from
                  hot soup and fresh eggs to toys and full meals. They're everywhere and incredibly convenient.</p>
              </div>

              <div
                class="fact-card daily-life bg-gradient-to-br from-purple-50 to-violet-100 p-6 rounded-xl border border-purple-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-purple-800">Punctual Trains</h3>
                </div>
                <p class="text-purple-700">Japan's Shinkansen bullet trains are famous for their punctuality, with
                  average delays of less than a minute. Railway companies even issue "late certificates" if trains are
                  delayed!</p>
              </div>

              <div
                class="fact-card daily-life bg-gradient-to-br from-teal-50 to-emerald-100 p-6 rounded-xl border border-teal-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-teal-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-teal-800">Shibuya Crossing</h3>
                </div>
                <p class="text-teal-700">Tokyo's Shibuya Crossing is the world's busiest pedestrian crossing, with
                  thousands of people crossing simultaneously during peak times. It's organized chaos at its finest!</p>
              </div>

              <!-- Culture & Customs Facts -->
              <div
                class="fact-card culture bg-gradient-to-br from-rose-50 to-pink-100 p-6 rounded-xl border border-rose-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-rose-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-rose-800">Slurping is Polite</h3>
                </div>
                <p class="text-rose-700">Unlike Western etiquette, slurping noodles in Japan is considered polite! It
                  shows appreciation for the chef and is believed to enhance the flavor of ramen and soba.</p>
              </div>

              <div
                class="fact-card culture bg-gradient-to-br from-indigo-50 to-blue-100 p-6 rounded-xl border border-indigo-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-indigo-800">Unlucky Number Four</h3>
                </div>
                <p class="text-indigo-700">The number four is considered unlucky because its pronunciation "shi" sounds
                  like the word for "death." Many buildings skip the fourth floor, and items are sold in sets of three
                  or five.</p>
              </div>

              <div
                class="fact-card culture bg-gradient-to-br from-yellow-50 to-amber-100 p-6 rounded-xl border border-yellow-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 2L3 7v11a1 1 0 001 1h3v-8h6v8h3a1 1 0 001-1V7l-7-5z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-yellow-800">Shoes Off Culture</h3>
                </div>
                <p class="text-yellow-700">Removing shoes before entering homes, some restaurants, or temples is
                  customary. Special slippers are provided for indoors, and separate ones for the bathroom!</p>
              </div>

              <!-- Unique Traditions Facts -->
              <div
                class="fact-card traditions bg-gradient-to-br from-pink-50 to-rose-100 p-6 rounded-xl border border-pink-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-pink-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-pink-800">Hanami Tradition</h3>
                </div>
                <p class="text-pink-700">Cherry blossom viewing (hanami) is a beloved spring tradition where people
                  gather for picnics under blooming sakura trees, celebrating the beauty and fleeting nature of life.
                </p>
              </div>

              <div
                class="fact-card traditions bg-gradient-to-br from-orange-50 to-red-100 p-6 rounded-xl border border-orange-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-orange-800">KFC Christmas</h3>
                </div>
                <p class="text-orange-700">Thanks to a clever 1970s marketing campaign, many Japanese families now eat
                  KFC for Christmas dinner! It's become a unique holiday tradition that requires advance booking.</p>
              </div>

              <div
                class="fact-card traditions bg-gradient-to-br from-emerald-50 to-green-100 p-6 rounded-xl border border-emerald-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                      <path fill-rule="evenodd"
                        d="M4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 1a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-emerald-800">Rabbit Island</h3>
                </div>
                <p class="text-emerald-700">Ōkunoshima, known as "Rabbit Island," is home to hundreds of wild but
                  friendly rabbits that roam freely and greet visitors. It's one of Japan's most adorable tourist
                  destinations!</p>
              </div>

              <div
                class="fact-card culture bg-gradient-to-br from-violet-50 to-purple-100 p-6 rounded-xl border border-violet-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-violet-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-violet-800">No Tipping Culture</h3>
                </div>
                <p class="text-violet-700">Tipping is not part of Japanese culture and can even be considered rude. The
                  price reflects the service value, and exceptional service is simply expected, not rewarded with extra
                  payment.</p>
              </div>

              <div
                class="fact-card daily-life bg-gradient-to-br from-cyan-50 to-blue-100 p-6 rounded-xl border border-cyan-200 hover:shadow-lg transition-shadow">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-cyan-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                      <path fill-rule="evenodd"
                        d="M4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 1a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-cyan-800">Robot Hotels</h3>
                </div>
                <p class="text-cyan-700">Japan is home to the Henn na Hotel, staffed almost entirely by robots,
                  including a dinosaur-shaped receptionist! It showcases Japan's embrace of cutting-edge technology in
                  daily life.</p>
              </div>
            </div>

            <!-- Fun Stats -->
            <div class="mt-12 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-200">
              <h3 class="text-xl font-bold text-indigo-800 mb-4 text-center">Did You Know?</h3>
              <div class="grid md:grid-cols-3 gap-4 text-center">
                <div class="bg-white rounded-lg p-4 shadow-sm">
                  <div class="text-2xl font-bold text-indigo-600">6,800+</div>
                  <div class="text-sm text-gray-600">Islands in Japan</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                  <div class="text-2xl font-bold text-purple-600">1,500+</div>
                  <div class="text-sm text-gray-600">Earthquakes per year</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                  <div class="text-2xl font-bold text-pink-600">70%</div>
                  <div class="text-sm text-gray-600">Mountainous terrain</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </main>

      <footer class="mt-12 rounded-t-2xl">
        <div class="flex flex-col items-center justify-center py-6 space-y-3 text-sm text-gray-600">
          <p>
            Developed with ❤️ by <span class="font-semibold text-gray-800">Hithesh N Poojary </span>
          </p>
          <div class="flex space-x-4">
            <a href="https://github.com/HitheshPoojary187" target="_blank" rel="noopener noreferrer"
              class="flex items-center px-3 py-1.5 bg-white shadow-md rounded-full text-indigo-600 hover:text-white hover:bg-indigo-600 transition duration-300 ease-in-out">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                <path
                  d="M12 .5C5.648.5.5 5.647.5 12c0 5.086 3.292 9.396 7.868 10.918.575.106.787-.25.787-.556v-2.06c-3.2.695-3.87-1.538-3.87-1.538-.523-1.33-1.28-1.686-1.28-1.686-1.046-.715.08-.7.08-.7 1.155.082 1.763 1.186 1.763 1.186 1.029 1.762 2.699 1.253 3.357.958.104-.746.402-1.253.73-1.541-2.554-.291-5.238-1.277-5.238-5.683 0-1.256.45-2.283 1.186-3.088-.12-.29-.514-1.463.112-3.052 0 0 .966-.309 3.165 1.179a11.02 11.02 0 012.88-.387c.977.004 1.963.132 2.88.387 2.198-1.488 3.163-1.179 3.163-1.179.628 1.589.234 2.762.114 3.052.738.805 1.185 1.832 1.185 3.088 0 4.418-2.688 5.388-5.253 5.672.41.354.776 1.055.776 2.126v3.146c0 .31.21.668.793.554C20.713 21.39 24 17.08 24 12c0-6.353-5.148-11.5-12-11.5z" />
              </svg>
              GitHub
            </a>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script>
      // Typewriter with loop: type full text, pause, erase, pause, repeat
      (function () {
        function startTypewriterLoop(targetElement, fullText, options) {
          var settings = Object.assign({ startDelayMs: 250, typeDelayMs: 140, holdFullMs: 900, eraseDelayMs: 80, holdEmptyMs: 600 }, options || {});
          if (!targetElement || !fullText) return;

          var index = 0;
          var typing = true;

          function tick() {
            if (typing) {
              if (index <= fullText.length) {
                targetElement.textContent = fullText.slice(0, index);
                index += 1;
                setTimeout(tick, settings.typeDelayMs);
              } else {
                typing = false;
                setTimeout(tick, settings.holdFullMs);
              }
            } else {
              if (index > 0) {
                index -= 1;
                targetElement.textContent = fullText.slice(0, index);
                setTimeout(tick, settings.eraseDelayMs);
              } else {
                typing = true;
                setTimeout(tick, settings.holdEmptyMs);
              }
            }
          }

          setTimeout(tick, settings.startDelayMs);
        }

        function initTypewriter() {
          var el = document.getElementById('typewriterText');
          startTypewriterLoop(el, 'こんにちは');
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initTypewriter);
        } else {
          initTypewriter();
        }
      })();
  </script>

  <script>
    // Enhanced Loading Screen Logic
    (function () {
      const loadingScreen = document.getElementById('loadingScreen');
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');

      const loadingSteps = [
        { text: "Initializing...", progress: 10 },
        { text: "Loading Japanese characters...", progress: 25 },
        { text: "Preparing flashcards...", progress: 40 },
        { text: "Setting up translator...", progress: 60 },
        { text: "Loading phrase database...", progress: 80 },
        { text: "Finalizing setup...", progress: 95 },
        { text: "Ready!", progress: 100 }
      ];

      let currentStep = 0;

      function updateLoadingStep() {
        if (currentStep < loadingSteps.length) {
          const step = loadingSteps[currentStep];
          loadingText.textContent = step.text;
          progressBar.style.width = step.progress + '%';
          currentStep++;

          // Vary timing for more realistic feel
          const delay = currentStep === loadingSteps.length ? 500 : (800 + Math.random() * 400);
          setTimeout(updateLoadingStep, delay);
        } else {
          // Hide loading screen with fade out
          setTimeout(() => {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.8s ease-out';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 800);
          }, 300);
        }
      }

      // Start loading sequence
      setTimeout(updateLoadingStep, 500);

      // Ensure loading screen is hidden if page loads very quickly
      window.addEventListener('load', () => {
        setTimeout(() => {
          if (loadingScreen.style.display !== 'none') {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }
        }, 2000); // Minimum 2 seconds display time
      });
    })();


  </script>

  <script>
    (function () {
      // --- Translator logic (from workspace, adapted) ---
      var API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5000' : '';
      var _wanakanaLoading = null;
      function loadScript(src) {
        return new Promise(function (resolve, reject) {
          var s = document.createElement('script');
          s.src = src; s.async = true; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
      }
      async function ensureWanakana() {
        if (window.wanakana) return;
        if (_wanakanaLoading) { await _wanakanaLoading; return; }
        var cdnPrimary = 'https://cdn.jsdelivr.net/npm/wanakana@5.1.0/umd/wanakana.min.js';
        var cdnFallback = 'https://unpkg.com/wanakana@5.1.0/umd/wanakana.min.js';
        _wanakanaLoading = (async function () {
          try { await loadScript(cdnPrimary); }
          catch (_) { try { await loadScript(cdnFallback); } catch (e) { } }
        })();
        await _wanakanaLoading;
      }

      var elInput = document.getElementById('inputText');
      var elType = document.getElementById('inputType');
      var elBtn = document.getElementById('translateBtn');
      var elOut = document.getElementById('outputText');

      async function doTranslate() {
        await ensureWanakana();
        var text = (elInput && elInput.value || '').trim();
        var type = elType ? elType.value : 'japanese';
        if (!text) { if (elOut) { elOut.classList.remove('hidden'); elOut.textContent = 'Please enter text.'; } return; }

        var sendText = text;
        var actualInputType = type;

        if (type === 'romanji' && window.wanakana) {
          // Check if this is actually Japanese romanji or English text
          const isLikelyJapaneseRomanji = isJapaneseRomanji(text);

          if (isLikelyJapaneseRomanji) {
            // Convert Japanese romanji to hiragana
            sendText = window.wanakana.toHiragana(text);
            actualInputType = 'japanese';
          } else {
            // Treat as English text
            sendText = text;
            actualInputType = 'english';
          }
        }
        // Debug info display removed

        function showLoader() {
          if (!elOut) return;
          elOut.classList.remove('hidden');
          elOut.innerHTML = '';
          var container = document.createElement('div');
          container.className = 'relative select-none';
          var center = document.createElement('div');
          center.className = 'flex items-center justify-center';
          center.innerHTML = '<svg class="loader-torii w-16 h-16 text-rose-500" viewBox="0 0 64 64" fill="currentColor" aria-hidden="true">\
<rect x="6" y="10" width="52" height="6" rx="2"></rect>\
<rect x="10" y="18" width="44" height="4" rx="2"></rect>\
<rect x="14" y="22" width="6" height="32" rx="1"></rect>\
<rect x="44" y="22" width="6" height="32" rx="1"></rect>\
<rect x="20" y="30" width="4" height="24" rx="1"></rect>\
<rect x="40" y="30" width="4" height="24" rx="1"></rect></svg>';
          var petalsHost = document.createElement('div');
          petalsHost.className = 'pointer-events-none absolute inset-0 overflow-hidden';
          petalsHost.style.height = '96px';
          for (var i = 0; i < 18; i++) {
            var p = document.createElement('div');
            p.className = 'sakura-petal';
            var left = Math.random() * 100;
            var delay = Math.random() * 1.5;
            var duration = 2.5 + Math.random() * 2.5;
            var scale = 0.8 + Math.random() * 0.8;
            p.style.left = left + '%';
            p.style.top = (-10 - Math.random() * 20) + 'px';
            p.style.transform = 'scale(' + scale + ')';
            p.style.animation = 'petalFall ' + duration + 's linear ' + delay + 's infinite';
            petalsHost.appendChild(p);
          }
          var label = document.createElement('div');
          label.className = 'text-center text-sm text-rose-500 mt-2';
          label.textContent = '桜が舞っています… Translating';
          container.appendChild(center);
          container.appendChild(petalsHost);
          container.appendChild(label);
          elOut.appendChild(container);
        }
        function hideLoader() { /* output will be replaced by result */ }

        try {
          showLoader();
          var url = API_BASE + '/translate?text=' + encodeURIComponent(sendText) + '&inputType=' + encodeURIComponent(actualInputType);
          var res = await fetch(url);
          var data = await res.json();
          if (data && data.error) {
            if (elOut) { elOut.classList.remove('hidden'); elOut.textContent = 'Error: ' + data.error; }
            return;
          }

          var html = '';

          if (type === 'romanji') {
            // For romanji input, always show Japanese and English
            if (actualInputType === 'japanese') {
              // Japanese romanji detected -> show English translation
              html = '<strong>Japanese:</strong> ' + (sendText || text) + '<br><strong>English:</strong> ' + (data.translated || '-');
            } else if (actualInputType === 'english') {
              // English text detected -> show Japanese translation
              html = '<strong>Japanese:</strong> ' + (data.translated || '-') + '<br><strong>English:</strong> ' + text;
            }

            // Add auto-detection note
            const detectedType = actualInputType === 'japanese' ? 'Japanese Romanji' : 'English';
            html += '<br><small style="color:#666;font-style:italic;">Auto-detected as: ' + detectedType + '</small>';

          } else if (type === 'japanese') {
            // Japanese input -> show Romanji and English
            html = '<strong>Romanji:</strong> ' + (data.romanized || '-') + '<br><strong>English:</strong> ' + (data.translated || '-');
          } else if (type === 'english') {
            // English input -> show Japanese and Romanji
            var roman = data.romanized;
            if (!roman && window.wanakana && data.translated) {
              roman = window.wanakana.toRomaji(data.translated);
            }
            html = '<strong>Japanese:</strong> ' + (data.translated || '-') + '<br><strong>Romanji:</strong> ' + (roman || '-');
          }
          if (elOut) { elOut.classList.remove('hidden'); elOut.innerHTML = html; }
        } catch (e) {
          if (elOut) { elOut.classList.remove('hidden'); elOut.textContent = 'Failed to contact server. Is the server running?'; }
        }
        finally { hideLoader(); }
      }

      if (elBtn) elBtn.addEventListener('click', doTranslate);
      if (elInput) elInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') doTranslate(); });
      if (elType) elType.addEventListener('change', function () { if (!elInput) return; elInput.placeholder = (elType.value === 'japanese') ? 'Type Japanese text...' : (elType.value === 'romanji' ? 'Type Romanji text...' : 'Type English text...'); });

      // Helper function to detect if text is Japanese romanji or English
      function isJapaneseRomanji(text) {
        // Common Japanese romanji patterns and words
        const japaneseRomanjiPatterns = [
          // Common Japanese syllables
          /\b(ka|ki|ku|ke|ko|ga|gi|gu|ge|go)\b/i,
          /\b(sa|shi|su|se|so|za|ji|zu|ze|zo)\b/i,
          /\b(ta|chi|tsu|te|to|da|de|do)\b/i,
          /\b(na|ni|nu|ne|no)\b/i,
          /\b(ha|hi|fu|he|ho|ba|bi|bu|be|bo|pa|pi|pu|pe|po)\b/i,
          /\b(ma|mi|mu|me|mo)\b/i,
          /\b(ya|yu|yo)\b/i,
          /\b(ra|ri|ru|re|ro)\b/i,
          /\b(wa|wo|n)\b/i,
          // Common Japanese words in romanji
          /\b(konnichiwa|arigatou|sayonara|ohayou|konbanwa|sumimasen|gomen|hai|iie)\b/i,
          /\b(watashi|anata|kore|sore|are|doko|nani|dare|itsu|doushite)\b/i,
          /\b(tabemasu|nomimasu|ikimasu|kimasu|mimasu|kikimasu)\b/i,
          // Japanese-specific character combinations
          /tsu|shu|chu|ryu|kyu|gyu|sha|cha|nya|hya|mya|rya/i,
          // Double consonants (common in Japanese)
          /kk|pp|tt|ss(?!ion)/i
        ];

        // English-specific patterns that are unlikely in Japanese romanji
        const englishPatterns = [
          // Common English words
          /\b(the|and|or|but|in|on|at|to|for|of|with|by)\b/i,
          /\b(i|you|he|she|it|we|they|me|him|her|us|them)\b/i,
          /\b(am|is|are|was|were|be|been|being|have|has|had|do|does|did)\b/i,
          /\b(like|love|want|need|can|could|will|would|should|must)\b/i,
          /\b(good|bad|big|small|hot|cold|new|old|young|happy|sad)\b/i,
          /\b(coffee|tea|water|food|house|car|book|phone|computer)\b/i,
          // English-specific letter combinations
          /th|ph|gh|ck|ng(?!a|i|u|e|o)|qu|x/i,
          // Common English suffixes
          /ing\b|ed\b|er\b|est\b|ly\b|tion\b|sion\b/i
        ];

        // Count matches for each type
        let japaneseScore = 0;
        let englishScore = 0;

        japaneseRomanjiPatterns.forEach(pattern => {
          if (pattern.test(text)) japaneseScore++;
        });

        englishPatterns.forEach(pattern => {
          if (pattern.test(text)) englishScore++;
        });

        // Additional checks
        const words = text.toLowerCase().split(/\s+/);

        // Check for Japanese-style word structure (mostly CV syllables)
        const japaneseStructure = words.some(word =>
          /^[aiueo]$|^[kgsztdnhbpmyrw][aiueo]([kgsztdnhbpmyrw][aiueo])*n?$/i.test(word)
        );

        if (japaneseStructure) japaneseScore += 2;

        // Check for English articles and common words
        const hasEnglishArticles = /\b(a|an|the)\b/i.test(text);
        if (hasEnglishArticles) englishScore += 3;

        // If no clear indicators, check length and character patterns
        if (japaneseScore === 0 && englishScore === 0) {
          // Short text with simple CV patterns might be Japanese
          if (text.length <= 20 && /^[a-z\s]*$/i.test(text) && !/[bcdfgjklpqvwxz]{2,}/i.test(text)) {
            return true;
          }
          // Longer text with complex patterns is likely English
          return false;
        }

        return japaneseScore > englishScore;
      }

      // --- Translation function for OCR ---
      async function translateExtractedText(text, inputType) {
        try {
          var sendText = text;
          var actualInputType = inputType;

          if (inputType === 'romanji' && window.wanakana) {
            // Check if this is actually Japanese romanji or English text
            const isLikelyJapaneseRomanji = isJapaneseRomanji(text);

            if (isLikelyJapaneseRomanji) {
              // Convert Japanese romanji to hiragana
              sendText = window.wanakana.toHiragana(text);
              actualInputType = 'japanese';
            } else {
              // Treat as English text
              sendText = text;
              actualInputType = 'english';
            }
          }

          var url = API_BASE + '/translate?text=' + encodeURIComponent(sendText) + '&inputType=' + encodeURIComponent(actualInputType);
          var res = await fetch(url);
          var data = await res.json();

          if (data && data.error) {
            throw new Error(data.error);
          }

          return data;
        } catch (error) {
          console.error('Translation error:', error);
          throw error;
        }
      }

      // --- Pronunciation functionality ---
      var elRomanjiInput = document.getElementById('romanjiInput');
      var elSpeakBtn = document.getElementById('speakBtn');
      var elJapaneseOutput = document.getElementById('japaneseOutput');
      var elJapaneseText = document.getElementById('japaneseText');
      var elPronunciationStatus = document.getElementById('pronunciationStatus');

      async function speakJapanese() {
        try {
          await ensureWanakana();
          var romanji = (elRomanjiInput && elRomanjiInput.value || '').trim();

          if (!romanji) {
            if (elPronunciationStatus) elPronunciationStatus.textContent = 'Please type a word!';
            return;
          }

          console.log('Input romanji:', romanji);

          // Convert to Hiragana
          var japaneseWord = window.wanakana ? window.wanakana.toHiragana(romanji) : romanji;
          console.log('Converted to Japanese:', japaneseWord);

          // Display the Japanese text
          if (elJapaneseText) elJapaneseText.textContent = japaneseWord;
          if (elJapaneseOutput) elJapaneseOutput.classList.remove('hidden');

          // Check if Web Speech API is available
          if (!('speechSynthesis' in window)) {
            if (elPronunciationStatus) elPronunciationStatus.textContent = 'Speech synthesis not supported in this browser';
            return;
          }

          // Stop any ongoing speech
          speechSynthesis.cancel();

          // Wait for voices to load
          await waitForVoices();

          // Get available voices
          const voices = speechSynthesis.getVoices();
          console.log('Available voices:', voices.length);

          // Find Japanese voice
          const japaneseVoice = voices.find(voice =>
            voice.lang.startsWith('ja') ||
            voice.name.toLowerCase().includes('japanese') ||
            voice.name.toLowerCase().includes('japan')
          );

          console.log('Japanese voice found:', japaneseVoice ? japaneseVoice.name : 'None');

          // Create utterance
          var utterance = new SpeechSynthesisUtterance(japaneseWord);

          // Set voice and language
          if (japaneseVoice) {
            utterance.voice = japaneseVoice;
          }
          utterance.lang = 'ja-JP';
          utterance.rate = 0.7; // Slower for learning
          utterance.pitch = 1.0;
          utterance.volume = 1.0;

          // Event handlers
          utterance.onstart = function () {
            console.log('Speech started');
            if (elPronunciationStatus) elPronunciationStatus.textContent = 'Speaking...';
          };

          utterance.onend = function () {
            console.log('Speech ended');
            if (elPronunciationStatus) elPronunciationStatus.textContent = 'Ready';
          };

          utterance.onerror = function (event) {
            console.error('Speech error:', event.error);
            if (elPronunciationStatus) {
              elPronunciationStatus.textContent = `Speech error: ${event.error}`;
            }
          };

          // Speak the text
          console.log('Starting speech synthesis');
          speechSynthesis.speak(utterance);

        } catch (error) {
          console.error('Pronunciation error:', error);
          if (elPronunciationStatus) {
            elPronunciationStatus.textContent = 'Error: ' + error.message;
          }
        }
      }

      // Helper function to wait for voices to load
      function waitForVoices() {
        return new Promise((resolve) => {
          const voices = speechSynthesis.getVoices();
          if (voices.length > 0) {
            resolve();
            return;
          }

          const voicesChangedHandler = () => {
            speechSynthesis.removeEventListener('voiceschanged', voicesChangedHandler);
            resolve();
          };

          speechSynthesis.addEventListener('voiceschanged', voicesChangedHandler);

          // Fallback timeout
          setTimeout(resolve, 1000);
        });
      }

      if (elSpeakBtn) elSpeakBtn.addEventListener('click', speakJapanese);
      if (elRomanjiInput) elRomanjiInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') speakJapanese(); });

      // Test voices functionality
      const testVoicesBtn = document.getElementById('testVoicesBtn');
      if (testVoicesBtn) {
        testVoicesBtn.addEventListener('click', async function () {
          try {
            if (!('speechSynthesis' in window)) {
              alert('Speech synthesis not supported in this browser');
              return;
            }

            await waitForVoices();
            const voices = speechSynthesis.getVoices();

            let voiceInfo = `Available voices (${voices.length} total):\n\n`;

            const japaneseVoices = voices.filter(voice =>
              voice.lang.startsWith('ja') ||
              voice.name.toLowerCase().includes('japanese') ||
              voice.name.toLowerCase().includes('japan')
            );

            if (japaneseVoices.length > 0) {
              voiceInfo += 'Japanese voices:\n';
              japaneseVoices.forEach(voice => {
                voiceInfo += `- ${voice.name} (${voice.lang}) ${voice.default ? '[Default]' : ''}\n`;
              });
            } else {
              voiceInfo += 'No Japanese voices found.\n';
              voiceInfo += '\nAll available voices:\n';
              voices.slice(0, 10).forEach(voice => {
                voiceInfo += `- ${voice.name} (${voice.lang})\n`;
              });
              if (voices.length > 10) {
                voiceInfo += `... and ${voices.length - 10} more\n`;
              }
            }

            voiceInfo += '\nNote: If no Japanese voices are available, the system will use the default voice which may not pronounce Japanese correctly.';

            alert(voiceInfo);
          } catch (error) {
            alert('Error testing voices: ' + error.message);
          }
        });
      }

      // Data
      var hiragana = [
        { char: "あ", romaji: "a" }, { char: "い", romaji: "i" }, { char: "う", romaji: "u" }, { char: "え", romaji: "e" }, { char: "お", romaji: "o" },
        { char: "か", romaji: "ka" }, { char: "き", romaji: "ki" }, { char: "く", romaji: "ku" }, { char: "け", romaji: "ke" }, { char: "こ", romaji: "ko" },
        { char: "さ", romaji: "sa" }, { char: "し", romaji: "shi" }, { char: "す", romaji: "su" }, { char: "せ", romaji: "se" }, { char: "そ", romaji: "so" },
        { char: "た", romaji: "ta" }, { char: "ち", romaji: "chi" }, { char: "つ", romaji: "tsu" }, { char: "て", romaji: "te" }, { char: "と", romaji: "to" },
        { char: "な", romaji: "na" }, { char: "に", romaji: "ni" }, { char: "ぬ", romaji: "nu" }, { char: "ね", romaji: "ne" }, { char: "の", romaji: "no" },
        { char: "は", romaji: "ha" }, { char: "ひ", romaji: "hi" }, { char: "ふ", romaji: "fu" }, { char: "へ", romaji: "he" }, { char: "ほ", romaji: "ho" },
        { char: "ま", romaji: "ma" }, { char: "み", romaji: "mi" }, { char: "む", romaji: "mu" }, { char: "め", romaji: "me" }, { char: "も", romaji: "mo" },
        { char: "や", romaji: "ya" }, { char: "ゆ", romaji: "yu" }, { char: "よ", romaji: "yo" },
        { char: "ら", romaji: "ra" }, { char: "り", romaji: "ri" }, { char: "る", romaji: "ru" }, { char: "れ", romaji: "re" }, { char: "ろ", romaji: "ro" },
        { char: "わ", romaji: "wa" }, { char: "を", romaji: "wo" },
        { char: "ん", romaji: "n" },
        { char: "が", romaji: "ga" }, { char: "ぎ", romaji: "gi" }, { char: "ぐ", romaji: "gu" }, { char: "げ", romaji: "ge" }, { char: "ご", romaji: "go" },
        { char: "ざ", romaji: "za" }, { char: "じ", romaji: "ji" }, { char: "ず", romaji: "zu" }, { char: "ぜ", romaji: "ze" }, { char: "ぞ", romaji: "zo" },
        { char: "だ", romaji: "da" }, { char: "ぢ", romaji: "ji" }, { char: "づ", romaji: "zu" }, { char: "で", romaji: "de" }, { char: "ど", romaji: "do" },
        { char: "ば", romaji: "ba" }, { char: "び", romaji: "bi" }, { char: "ぶ", romaji: "bu" }, { char: "べ", romaji: "be" }, { char: "ぼ", romaji: "bo" },
        { char: "ぱ", romaji: "pa" }, { char: "ぴ", romaji: "pi" }, { char: "ぷ", romaji: "pu" }, { char: "ぺ", romaji: "pe" }, { char: "ぽ", romaji: "po" },
        { char: "きゃ", romaji: "kya" }, { char: "きゅ", romaji: "kyu" }, { char: "きょ", romaji: "kyo" },
        { char: "しゃ", romaji: "sha" }, { char: "しゅ", romaji: "shu" }, { char: "しょ", romaji: "sho" },
        { char: "ちゃ", romaji: "cha" }, { char: "ちゅ", romaji: "chu" }, { char: "ちょ", romaji: "cho" },
        { char: "にゃ", romaji: "nya" }, { char: "にゅ", romaji: "nyu" }, { char: "にょ", romaji: "nyo" },
        { char: "ひゃ", romaji: "hya" }, { char: "ひゅ", romaji: "hyu" }, { char: "ひょ", romaji: "hyo" },
        { char: "みゃ", romaji: "mya" }, { char: "みゅ", romaji: "myu" }, { char: "みょ", romaji: "myo" },
        { char: "りゃ", romaji: "rya" }, { char: "りゅ", romaji: "ryu" }, { char: "りょ", romaji: "ryo" },
        { char: "ぎゃ", romaji: "gya" }, { char: "ぎゅ", romaji: "gyu" }, { char: "ぎょ", romaji: "gyo" },
        { char: "じゃ", romaji: "ja" }, { char: "じゅ", romaji: "ju" }, { char: "じょ", romaji: "jo" },
        { char: "びゃ", romaji: "bya" }, { char: "びゅ", romaji: "byu" }, { char: "びょ", romaji: "byo" },
        { char: "ぴゃ", romaji: "pya" }, { char: "ぴゅ", romaji: "pyu" }, { char: "ぴょ", romaji: "pyo" },
      ];

      var katakana = [
        { char: "ア", romaji: "a" }, { char: "イ", romaji: "i" }, { char: "ウ", romaji: "u" }, { char: "エ", romaji: "e" }, { char: "オ", romaji: "o" },
        { char: "カ", romaji: "ka" }, { char: "キ", romaji: "ki" }, { char: "ク", romaji: "ku" }, { char: "ケ", romaji: "ke" }, { char: "コ", romaji: "ko" },
        { char: "サ", romaji: "sa" }, { char: "シ", romaji: "shi" }, { char: "ス", romaji: "su" }, { char: "セ", romaji: "se" }, { char: "ソ", romaji: "so" },
        { char: "タ", romaji: "ta" }, { char: "チ", romaji: "chi" }, { char: "ツ", romaji: "tsu" }, { char: "テ", romaji: "te" }, { char: "ト", romaji: "to" },
        { char: "ナ", romaji: "na" }, { char: "ニ", romaji: "ni" }, { char: "ヌ", romaji: "nu" }, { char: "ネ", romaji: "ne" }, { char: "ノ", romaji: "no" },
        { char: "ハ", romaji: "ha" }, { char: "ヒ", romaji: "hi" }, { char: "フ", romaji: "fu" }, { char: "ヘ", romaji: "he" }, { char: "ホ", romaji: "ho" },
        { char: "マ", romaji: "ma" }, { char: "ミ", romaji: "mi" }, { char: "ム", romaji: "mu" }, { char: "メ", romaji: "me" }, { char: "モ", romaji: "mo" },
        { char: "ヤ", romaji: "ya" }, { char: "ユ", romaji: "yu" }, { char: "ヨ", romaji: "yo" },
        { char: "ラ", romaji: "ra" }, { char: "リ", romaji: "ri" }, { char: "ル", romaji: "ru" }, { char: "レ", romaji: "re" }, { char: "ロ", romaji: "ro" },
        { char: "ワ", romaji: "wa" }, { char: "ヲ", romaji: "wo" },
        { char: "ン", romaji: "n" },
        { char: "ガ", romaji: "ga" }, { char: "ギ", romaji: "gi" }, { char: "グ", romaji: "gu" }, { char: "ゲ", romaji: "ge" }, { char: "ゴ", romaji: "go" },
        { char: "ザ", romaji: "za" }, { char: "ジ", romaji: "ji" }, { char: "ズ", romaji: "zu" }, { char: "ゼ", romaji: "ze" }, { char: "ゾ", romaji: "zo" },
        { char: "ダ", romaji: "da" }, { char: "ヂ", romaji: "ji" }, { char: "ヅ", romaji: "zu" }, { char: "デ", romaji: "de" }, { char: "ド", romaji: "do" },
        { char: "バ", romaji: "ba" }, { char: "ビ", romaji: "bi" }, { char: "ブ", romaji: "bu" }, { char: "ベ", romaji: "be" }, { char: "ボ", romaji: "bo" },
        { char: "パ", romaji: "pa" }, { char: "ピ", romaji: "pi" }, { char: "プ", romaji: "pu" }, { char: "ペ", romaji: "pe" }, { char: "ポ", romaji: "po" },
        { char: "キャ", romaji: "kya" }, { char: "キュ", romaji: "kyu" }, { char: "キョ", romaji: "kyo" },
        { char: "シャ", romaji: "sha" }, { char: "シュ", romaji: "shu" }, { char: "ショ", romaji: "sho" },
        { char: "チャ", romaji: "cha" }, { char: "チュ", romaji: "chu" }, { char: "チョ", romaji: "cho" },
        { char: "ニャ", romaji: "nya" }, { char: "ニュ", romaji: "nyu" }, { char: "ニョ", romaji: "nyo" },
        { char: "ヒャ", romaji: "hya" }, { char: "ヒュ", romaji: "hyu" }, { char: "ヒョ", romaji: "hyo" },
        { char: "ミャ", romaji: "mya" }, { char: "ミュ", romaji: "myu" }, { char: "ミョ", romaji: "myo" },
        { char: "リャ", romaji: "rya" }, { char: "リュ", romaji: "ryu" }, { char: "リョ", romaji: "ryo" },
        { char: "ギャ", romaji: "gya" }, { char: "ギュ", romaji: "gyu" }, { char: "ギョ", romaji: "gyo" },
        { char: "ジャ", romaji: "ja" }, { char: "ジュ", romaji: "ju" }, { char: "ジョ", romaji: "jo" },
        { char: "ビャ", romaji: "bya" }, { char: "ビュ", romaji: "byu" }, { char: "ビョ", romaji: "byo" },
        { char: "ピャ", romaji: "pya" }, { char: "ピュ", romaji: "pyu" }, { char: "ピョ", romaji: "pyo" },
      ];

      function shuffleArray(arr) {
        var a = arr.slice();
        for (var i = a.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var t = a[i]; a[i] = a[j]; a[j] = t;
        }
        return a;
      }

      var createSection = document.getElementById('createSection');
      var numInput = document.getElementById('numInput');
      var createBtn = document.getElementById('createBtn');
      var optionsPanel = document.getElementById('optionsPanel');

      // Nav and sections
      var homeSection = document.getElementById('homeSection');
      var translatorSection = document.getElementById('translatorSection');
      var pronunciationSection = document.getElementById('pronunciationSection');
      var btnNavHome = document.getElementById('btnNavHome');
      var btnNavFlashcards = document.getElementById('btnNavFlashcards');
      var btnNavTranslator = document.getElementById('btnNavTranslator');
      var btnNavPronunciation = document.getElementById('btnNavPronunciation');
      var btnNavKanjiOCR = document.getElementById('btnNavKanjiOCR');

      var btnHiragana = document.getElementById('btnHiragana');
      var btnKatakana = document.getElementById('btnKatakana');
      var btnCharToRomaji = document.getElementById('btnCharToRomaji');
      var btnRomajiToChar = document.getElementById('btnRomajiToChar');
      var flipBtn = document.getElementById('flipBtn');
      var nextBtn = document.getElementById('nextBtn');
      var resetBtn = document.getElementById('resetBtn');
      var restartBtn = document.getElementById('restartBtn');
      var flashcard = document.getElementById('flashcard');
      var frontText = document.getElementById('frontText');
      var backText = document.getElementById('backText');
      var countText = document.getElementById('countText');
      var cardArea = document.getElementById('cardArea');
      var sessionComplete = document.getElementById('sessionComplete');

      var desiredCount = 10;
      var currentAlphabet = hiragana;
      var mode = 'charToRomaji';
      var deck = [];
      var currentIndex = 0;
      var isFlipped = false;
      var isSessionCompleted = false;



      function hideFlashcardUI() {
        cardArea.classList.add('hidden');
        sessionComplete.classList.add('hidden');
        optionsPanel.classList.add('hidden');
        resetBtn.classList.add('hidden');
      }

      function showHome() {
        if (homeSection) homeSection.classList.remove('hidden');
        createSection.classList.add('hidden');
        translatorSection.classList.add('hidden');
        pronunciationSection.classList.add('hidden');
        if (phrasesSection) phrasesSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        hideFlashcardUI();
        setNavActive('home');
      }

      function showFlashcards() {
        if (homeSection) homeSection.classList.add('hidden');
        translatorSection.classList.add('hidden');
        pronunciationSection.classList.add('hidden');
        if (phrasesSection) phrasesSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        createSection.classList.remove('hidden');
        optionsPanel.classList.add('hidden');
        cardArea.classList.add('hidden');
        sessionComplete.classList.add('hidden');
        setNavActive('flashcards');
      }

      function showTranslator() {
        if (homeSection) homeSection.classList.add('hidden');
        createSection.classList.add('hidden');
        pronunciationSection.classList.add('hidden');
        if (phrasesSection) phrasesSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        optionsPanel.classList.add('hidden');
        cardArea.classList.add('hidden');
        sessionComplete.classList.add('hidden');
        translatorSection.classList.remove('hidden');
        setNavActive('translator');
      }

      function showPronunciation() {
        if (homeSection) homeSection.classList.add('hidden');
        createSection.classList.add('hidden');
        translatorSection.classList.add('hidden');
        if (phrasesSection) phrasesSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        optionsPanel.classList.add('hidden');
        cardArea.classList.add('hidden');
        sessionComplete.classList.add('hidden');
        pronunciationSection.classList.remove('hidden');
        setNavActive('pronunciation');
      }

      function showKanjiOCR() {
        console.log('showKanjiOCR function called');
        // Hide all other sections
        const sections = [
          homeSection,
          createSection,
          translatorSection,
          pronunciationSection,
          document.getElementById('phrasesSection'),
          document.getElementById('factsSection'),
          optionsPanel,
          cardArea,
          sessionComplete
        ];

        sections.forEach(section => {
          if (section) section.classList.add('hidden');
        });

        // Show KanjiOCR section
        const ocrSection = document.getElementById('kanjiOCRSection');
        if (ocrSection) {
          console.log('Showing KanjiOCR section');
          ocrSection.classList.remove('hidden');
        } else {
          console.error('KanjiOCR section not found');
        }

        // Set nav active
        setNavActive('kanjiocr');

        // Show KanjiOCR section
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) {
          console.log('Making KanjiOCR section visible');
          kanjiOCRSection.classList.remove('hidden');
        } else {
          console.error('KanjiOCR section element not found');
        }

        // Set nav active
        setNavActive('kanjiocr');
      }

      function setActive(el, active) {
        if (!el) return;
        if (active) {
          el.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
          el.classList.add('bg-blue-500', 'text-white', 'shadow');
        } else {
          el.classList.remove('bg-blue-500', 'text-white', 'shadow');
          el.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
      }

      function clearAllActives() {
        setActive(btnHiragana, false);
        setActive(btnKatakana, false);
        setActive(btnCharToRomaji, false);
        setActive(btnRomajiToChar, false);
      }

      function updateCount() {
        countText.textContent = 'Card ' + (currentIndex + 1) + ' of ' + deck.length;
      }

      function renderCard() {
        if (!deck.length) return;
        var card = deck[currentIndex];
        var front = (mode === 'charToRomaji') ? card.char : card.romaji;
        var back = (mode === 'charToRomaji') ? card.romaji : card.char;
        frontText.textContent = front;
        backText.textContent = back;
      }

      function resetFlip() {
        isFlipped = false;
        flashcard.classList.remove('[transform:rotateY(180deg)]');
        flipBtn.textContent = 'Show Answer';
      }

      function buildDeck() {
        var base = shuffleArray(currentAlphabet);
        var n = parseInt(desiredCount, 10);
        if (!isFinite(n) || n < 1) n = 1;
        if (n > base.length) n = base.length;
        return base.slice(0, n);
      }

      function startSession() {
        // Hide options and create to meet requirement
        optionsPanel.classList.add('hidden');
        createSection.classList.add('hidden');

        deck = buildDeck();
        currentIndex = 0;
        isSessionCompleted = false;
        cardArea.classList.remove('hidden');
        sessionComplete.classList.add('hidden');
        resetBtn.classList.remove('hidden');
        resetFlip();
        renderCard();
        updateCount();
        nextBtn.textContent = (deck.length > 1) ? 'Next Card' : 'Finish Session';
      }

      function finishSession() {
        isSessionCompleted = true;
        cardArea.classList.add('hidden');
        sessionComplete.classList.remove('hidden');
      }

      function resetToInitial() {
        // Hide running states
        cardArea.classList.add('hidden');
        sessionComplete.classList.add('hidden');

        // Show create input and button, hide options until user clicks create
        createSection.classList.remove('hidden');
        createBtn.classList.remove('hidden');
        optionsPanel.classList.add('hidden');

        // UI resets
        clearAllActives();
        currentAlphabet = hiragana;
        mode = 'charToRomaji';
        deck = [];
        currentIndex = 0;
        isFlipped = false;
        isSessionCompleted = false;
        resetBtn.classList.add('hidden');
        numInput.value = '';
      }

      // Create button: show options and hide itself
      createBtn.addEventListener('click', function () {
        var val = parseInt(numInput.value, 10);
        if (isFinite(val) && val > 0) {
          desiredCount = val;
        } else {
          desiredCount = 10;
        }
        createBtn.classList.add('hidden');
        optionsPanel.classList.remove('hidden');
      });

      // Navbar navigation
      if (btnNavHome) {
        btnNavHome.addEventListener('click', function () {
          showHome();
        });
      }
      if (btnNavFlashcards) {
        btnNavFlashcards.addEventListener('click', function () {
          showFlashcards();
        });
      }
      if (btnNavTranslator) {
        btnNavTranslator.addEventListener('click', function () {
          showTranslator();
        });
      }
      if (btnNavPronunciation) {
        btnNavPronunciation.addEventListener('click', function () {
          showPronunciation();
        });
      }
      // Event listeners for options; clicking any generates deck with desiredCount
      btnHiragana.addEventListener('click', function () {
        currentAlphabet = hiragana;
        setActive(btnHiragana, true);
        setActive(btnKatakana, false);
        startSession();
      });

      btnKatakana.addEventListener('click', function () {
        currentAlphabet = katakana;
        setActive(btnHiragana, false);
        setActive(btnKatakana, true);
        startSession();
      });

      btnCharToRomaji.addEventListener('click', function () {
        currentAlphabet = katakana;  // Set to katakana for "Romanji → Katakana"
        mode = 'romajiToChar';       // Show romanji on front, katakana on back
        setActive(btnCharToRomaji, true);
        setActive(btnRomajiToChar, false);
        startSession();
      });

      btnRomajiToChar.addEventListener('click', function () {
        currentAlphabet = hiragana;  // Set to hiragana for "Romaji → Hiragana"
        mode = 'romajiToChar';       // Show romanji on front, hiragana on back
        setActive(btnCharToRomaji, false);
        setActive(btnRomajiToChar, true);
        startSession();
      });

      // Card controls
      flipBtn.addEventListener('click', function () {
        if (isSessionCompleted) return;
        isFlipped = !isFlipped;
        if (isFlipped) {
          flashcard.classList.add('[transform:rotateY(180deg)]');
          flipBtn.textContent = 'Hide Answer';
        } else {
          flashcard.classList.remove('[transform:rotateY(180deg)]');
          flipBtn.textContent = 'Show Answer';
        }
      });

      nextBtn.addEventListener('click', function () {
        if (isSessionCompleted) return;
        resetFlip();
        if (currentIndex < deck.length - 1) {
          currentIndex += 1;
          renderCard();
          updateCount();
          nextBtn.textContent = (currentIndex < deck.length - 1) ? 'Next Card' : 'Finish Session';
        } else {
          finishSession();
        }
      });

      if (restartBtn) {
        restartBtn.addEventListener('click', function () {
          startSession();
        });
      }

      resetBtn.addEventListener('click', function () {
        resetToInitial();
      });

      // --- Phrases functionality ---
      var phrasesSection = document.getElementById('phrasesSection');
      var btnNavPhrases = document.getElementById('btnNavPhrases');
      var phrasesContainer = document.getElementById('phrasesContainer');
      var searchInput = document.getElementById('searchInput');
      var showAllBtn = document.getElementById('showAllBtn');
      var showPhrasesBtn = document.getElementById('showPhrasesBtn');
      var showWordsBtn = document.getElementById('showWordsBtn');
      var phrasesStats = document.getElementById('phrasesStats');
      var currentCount = document.getElementById('currentCount');
      var totalCount = document.getElementById('totalCount');

      var allPhrasesData = [];
      var currentFilter = 'all';
      var filteredData = [];

      function updateNavForPhrases() {
        // Reset all nav buttons
        if (btnNavHome) {
          btnNavHome.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavHome.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavFlashcards) {
          btnNavFlashcards.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavFlashcards.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavTranslator) {
          btnNavTranslator.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavTranslator.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavPronunciation) {
          btnNavPronunciation.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavPronunciation.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavPhrases) {
          btnNavPhrases.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
          btnNavPhrases.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
        }
      }

      function showPhrases() {
        if (homeSection) homeSection.classList.add('hidden');
        createSection.classList.add('hidden');
        translatorSection.classList.add('hidden');
        pronunciationSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        hideFlashcardUI();
        phrasesSection.classList.remove('hidden');
        setNavActive('phrases');
        loadPhrasesData();
      }

      async function loadPhrasesData() {
        if (allPhrasesData.length > 0) {
          renderPhrases();
          return;
        }

        try {
          var response = await fetch(API_BASE + '/api/phrases');
          var data = await response.json();

          if (data.error) {
            phrasesContainer.innerHTML = '<div class="text-center py-8 text-red-500">Error loading phrases: ' + data.error + '</div>';
            return;
          }

          // Combine phrases and words with type indicator
          allPhrasesData = [];
          if (data.phrases) {
            data.phrases.forEach(function (phrase) {
              allPhrasesData.push({ ...phrase, type: 'phrase' });
            });
          }
          if (data.words) {
            data.words.forEach(function (word) {
              allPhrasesData.push({ ...word, type: 'word' });
            });
          }

          renderPhrases();
        } catch (error) {
          phrasesContainer.innerHTML = '<div class="text-center py-8 text-red-500">Failed to load phrases. Please check if the server is running.</div>';
        }
      }

      function filterData() {
        var searchTerm = searchInput.value.toLowerCase().trim();

        filteredData = allPhrasesData.filter(function (item) {
          // Filter by type
          if (currentFilter === 'phrases' && item.type !== 'phrase') return false;
          if (currentFilter === 'words' && item.type !== 'word') return false;

          // Filter by search term
          if (searchTerm) {
            return item.japanese.toLowerCase().includes(searchTerm) ||
              item.romaji.toLowerCase().includes(searchTerm) ||
              item.english.toLowerCase().includes(searchTerm);
          }

          return true;
        });
      }

      function renderPhrases() {
        filterData();

        if (filteredData.length === 0) {
          phrasesContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No phrases found matching your criteria.</div>';
          phrasesStats.classList.add('hidden');
          return;
        }

        var html = '';
        filteredData.forEach(function (item) {
          var typeColor = item.type === 'phrase' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
          html += '<div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">';
          html += '<div class="flex items-start justify-between mb-2">';
          html += '<div class="text-2xl font-bold text-gray-800">' + item.japanese + '</div>';
          html += '<span class="px-2 py-1 rounded-full text-xs font-medium ' + typeColor + '">' + item.type + '</span>';
          html += '</div>';
          html += '<div class="text-lg text-indigo-600 mb-1">' + item.romaji + '</div>';
          html += '<div class="text-gray-700">' + item.english + '</div>';
          html += '</div>';
        });

        phrasesContainer.innerHTML = html;

        // Update stats
        currentCount.textContent = filteredData.length;
        totalCount.textContent = allPhrasesData.length;
        phrasesStats.classList.remove('hidden');
      }

      function setFilterActive(activeBtn) {
        // Reset all filter buttons
        showAllBtn.classList.remove('bg-indigo-600', 'text-white');
        showAllBtn.classList.add('bg-gray-200', 'text-gray-700');
        showPhrasesBtn.classList.remove('bg-indigo-600', 'text-white');
        showPhrasesBtn.classList.add('bg-gray-200', 'text-gray-700');
        showWordsBtn.classList.remove('bg-indigo-600', 'text-white');
        showWordsBtn.classList.add('bg-gray-200', 'text-gray-700');

        // Set active button
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-indigo-600', 'text-white');
      }

      // Event listeners for phrases
      if (btnNavPhrases) {
        btnNavPhrases.addEventListener('click', showPhrases);
      }

      // Event listener for dummy
      if (btnNavKanjiOCR) {
        btnNavKanjiOCR.addEventListener('click', showKanjiOCR);
      }

      // KanjiOCR Workflow State Management
      const workflowState = {
        currentStep: 'initial', // initial, selecting, cropping, processing, results, error
        selectedImage: null,
        croppedImage: null,
        cropData: null,
        ocrResult: null,
        error: null,
        isLoading: false
      };

      // UI State Management
      const uiElements = {
        imageSelectionInterface: null,
        cameraInterface: null,
        croppingInterface: null,
        processingInterface: null,
        resultsInterface: null,
        workflowProgress: null,
        messages: null
      };

      // Initialize UI elements
      function initializeUIElements() {
        uiElements.imageSelectionInterface = document.getElementById('imageSelectionInterface');
        uiElements.cameraInterface = document.getElementById('cameraInterface');
        uiElements.croppingInterface = document.getElementById('croppingInterface');
        uiElements.processingInterface = document.getElementById('processingInterface');
        uiElements.resultsInterface = document.getElementById('resultsInterface');
        uiElements.workflowProgress = document.getElementById('workflowProgress');
        uiElements.messages = document.getElementById('messages');
      }

      // Show/Hide Interface Sections
      function showInterface(interfaceName) {
        // Hide all interfaces
        Object.values(uiElements).forEach(element => {
          if (element && element.classList) {
            element.classList.add('hidden');
            element.classList.remove('workflow-fade-in');
          }
        });

        // Show specific interface with animation
        const targetInterface = uiElements[interfaceName];
        if (targetInterface) {
          targetInterface.classList.remove('hidden');
          targetInterface.classList.add('workflow-fade-in');
        }

        // Update progress breadcrumbs
        updateProgressBreadcrumbs();
      }

      // Update Progress Breadcrumbs
      function updateProgressBreadcrumbs() {
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        if (!step1 || !step2 || !step3) return;

        // Reset all steps
        [step1, step2, step3].forEach(step => {
          step.className = 'px-3 py-1 rounded-full bg-gray-100 text-gray-500';
        });

        // Update based on current step
        switch (workflowState.currentStep) {
          case 'initial':
          case 'selecting':
            step1.className = 'px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium';
            uiElements.workflowProgress.classList.add('hidden');
            break;
          case 'cropping':
            step1.className = 'px-3 py-1 rounded-full step-completed';
            step2.className = 'px-3 py-1 rounded-full step-active';
            uiElements.workflowProgress.classList.remove('hidden');
            break;
          case 'processing':
            step1.className = 'px-3 py-1 rounded-full step-completed';
            step2.className = 'px-3 py-1 rounded-full step-completed';
            step3.className = 'px-3 py-1 rounded-full step-active';
            break;
          case 'results':
            [step1, step2, step3].forEach(step => {
              step.className = 'px-3 py-1 rounded-full step-completed';
            });
            break;
        }
      }

      // Show Alert Messages
      function showAlert(message, type = 'error') {
        const alertClass = type === 'error' ? 'from-red-500 to-red-600' :
          type === 'success' ? 'from-green-500 to-green-600' :
            'from-blue-500 to-blue-600';
        const iconClass = type === 'error' ? 'fa-exclamation-triangle' :
          type === 'success' ? 'fa-check-circle' :
            'fa-info-circle';

        const alertHtml = `
          <div class="bg-gradient-to-r ${alertClass} text-white p-4 rounded-xl shadow-lg mb-6 workflow-fade-in">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <i class="fas ${iconClass} mr-3 text-lg"></i>
                <span class="font-medium">${message}</span>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;

        if (uiElements.messages) {
          uiElements.messages.innerHTML = alertHtml + uiElements.messages.innerHTML;
          // Auto-remove success messages after 5 seconds
          if (type === 'success') {
            setTimeout(() => {
              const alerts = uiElements.messages.querySelectorAll('.bg-gradient-to-r');
              if (alerts.length > 0) alerts[0].remove();
            }, 5000);
          }
        }
      }

      // Clear Messages
      function clearMessages() {
        if (uiElements.messages) {
          uiElements.messages.innerHTML = '';
        }
      }

      // Reset Workflow
      function resetWorkflow() {
        workflowState.currentStep = 'initial';
        workflowState.selectedImage = null;
        workflowState.croppedImage = null;
        workflowState.cropData = null;
        workflowState.ocrResult = null;
        workflowState.error = null;
        workflowState.isLoading = false;

        clearMessages();
        showInterface('imageSelectionInterface');

        // Reset file input
        const imageInput = document.getElementById('imageInput');
        if (imageInput) imageInput.value = '';

        // Reset text input
        const textInput = document.getElementById('textInput');
        if (textInput) textInput.value = '';

        // Clear results
        const output = document.getElementById('output');
        if (output) output.innerHTML = '';
      }

      // Image Selection Functions
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file
        if (!validateImageFile(file)) return;

        workflowState.selectedImage = file;
        workflowState.currentStep = 'cropping';

        showAlert(`Image selected: ${file.name}`, 'success');
        initializeCropping(file);
      }

      function validateImageFile(file) {
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (!validTypes.includes(file.type)) {
          showAlert('Please select a valid image file (JPG, PNG, or WebP)');
          return false;
        }

        if (file.size > maxSize) {
          showAlert('Image file is too large. Please select an image smaller than 5MB');
          return false;
        }

        return true;
      }

      // Camera Functions
      let cameraStream = null;

      async function initializeCamera() {
        try {
          workflowState.currentStep = 'selecting';
          showInterface('cameraInterface');

          const video = document.getElementById('cameraVideo');
          const constraints = {
            video: {
              facingMode: 'environment', // Use back camera for text capture
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          };

          cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = cameraStream;

          showAlert('Camera initialized successfully', 'success');
        } catch (error) {
          console.error('Camera error:', error);
          if (error.name === 'NotAllowedError') {
            showAlert('Camera permission denied. Please allow camera access and try again.');
          } else if (error.name === 'NotFoundError') {
            showAlert('No camera found. Please use the upload option instead.');
          } else {
            showAlert('Failed to initialize camera. Please try the upload option.');
          }
          resetWorkflow();
        }
      }

      function capturePhoto() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('cameraCanvas');
        const context = canvas.getContext('2d');

        // Set canvas dimensions to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw the video frame to canvas (flip horizontally to correct mirror effect)
        context.scale(-1, 1);
        context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        context.scale(-1, 1);

        // Convert canvas to blob
        canvas.toBlob((blob) => {
          if (blob) {
            workflowState.selectedImage = blob;
            workflowState.currentStep = 'cropping';

            stopCamera();
            showAlert('Photo captured successfully', 'success');
            initializeCropping(blob);
          } else {
            showAlert('Failed to capture photo. Please try again.');
          }
        }, 'image/jpeg', 0.9);
      }

      function stopCamera() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
      }

      function cancelCamera() {
        stopCamera();
        resetWorkflow();
      }

      // Cropping Functions
      let cropState = {
        image: null,
        canvas: null,
        context: null,
        cropBox: null,
        isDragging: false,
        isResizing: false,
        dragStart: { x: 0, y: 0 },
        resizeHandle: null,
        imageRect: null
      };

      function initializeCropping(imageFile) {
        console.log('Initializing cropping with image:', imageFile);
        showInterface('croppingInterface');

        const cropImage = document.getElementById('cropImage');
        const cropBox = document.getElementById('cropBox');

        if (!cropImage || !cropBox) {
          console.error('Crop elements not found:', { cropImage, cropBox });
          showAlert('Cropping interface not properly initialized');
          return;
        }

        // Create object URL for the image
        const imageUrl = URL.createObjectURL(imageFile);
        cropImage.src = imageUrl;

        cropImage.onload = function () {
          console.log('Image loaded for cropping');

          // Wait a bit for the image to be fully rendered
          setTimeout(() => {
            // Initialize crop box to cover most of the image
            const imageRect = cropImage.getBoundingClientRect();
            const containerRect = document.getElementById('cropContainer').getBoundingClientRect();

            cropState.imageRect = {
              left: imageRect.left - containerRect.left,
              top: imageRect.top - containerRect.top,
              width: imageRect.width,
              height: imageRect.height
            };

            console.log('Image rect:', cropState.imageRect);

            // Set initial crop box (80% of image, centered)
            const cropWidth = cropState.imageRect.width * 0.8;
            const cropHeight = cropState.imageRect.height * 0.8;
            const cropLeft = cropState.imageRect.left + (cropState.imageRect.width - cropWidth) / 2;
            const cropTop = cropState.imageRect.top + (cropState.imageRect.height - cropHeight) / 2;

            cropBox.style.left = cropLeft + 'px';
            cropBox.style.top = cropTop + 'px';
            cropBox.style.width = cropWidth + 'px';
            cropBox.style.height = cropHeight + 'px';
            cropBox.style.display = 'block';

            console.log('Crop box initialized:', {
              left: cropLeft,
              top: cropTop,
              width: cropWidth,
              height: cropHeight
            });

            // Initialize crop interactions
            initializeCropInteractions();
          }, 100);
        };

        cropImage.onerror = function () {
          console.error('Failed to load image for cropping');
          showAlert('Failed to load image for cropping');
        };
      }

      function initializeCropInteractions() {
        const cropBox = document.getElementById('cropBox');
        const cropContainer = document.getElementById('cropContainer');

        if (!cropBox || !cropContainer) {
          console.error('Crop interaction elements not found');
          return;
        }

        console.log('Initializing crop interactions');

        // Remove any existing event listeners
        cropBox.removeEventListener('mousedown', startCropDrag);
        document.removeEventListener('mousemove', handleCropDrag);
        document.removeEventListener('mouseup', endCropDrag);

        // Add event listeners for crop box interactions
        cropBox.addEventListener('mousedown', startCropDrag);
        document.addEventListener('mousemove', handleCropDrag);
        document.addEventListener('mouseup', endCropDrag);

        // Add event listeners for resize handles
        const handles = cropBox.querySelectorAll('div[data-handle]');
        console.log('Found resize handles:', handles.length);

        handles.forEach((handle) => {
          // Mouse events for desktop
          handle.addEventListener('mousedown', (e) => {
            console.log('Handle clicked:', handle.dataset.handle);
            startCropResize(e, handle.dataset.handle);
          });
          
          // Touch events for mobile
          handle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            console.log('Handle touched:', handle.dataset.handle);
            const touch = e.touches[0];
            startCropResize({
              clientX: touch.clientX,
              clientY: touch.clientY,
              preventDefault: () => {}
            }, handle.dataset.handle);
          });
        });

        // Touch events for mobile crop box movement
        cropBox.addEventListener('touchstart', startCropDragTouch);
        document.addEventListener('touchmove', handleCropDragTouch);
        document.addEventListener('touchend', endCropDrag);

        // Prevent default drag behavior on handles
        handles.forEach(handle => {
          handle.addEventListener('dragstart', (e) => e.preventDefault());
        });

        console.log('Crop interactions initialized successfully');
      }

      function startCropDrag(e) {
        if (e.target.hasAttribute('data-handle')) return; // Don't drag when clicking handles

        cropState.isDragging = true;
        cropState.dragStart = { x: e.clientX, y: e.clientY };
        e.preventDefault();
        e.stopPropagation();
      }

      function startCropDragTouch(e) {
        if (e.target.hasAttribute('data-handle')) return;

        cropState.isDragging = true;
        const touch = e.touches[0];
        cropState.dragStart = { x: touch.clientX, y: touch.clientY };
        e.preventDefault();
        e.stopPropagation();
      }

      function handleCropDrag(e) {
        if (!cropState.isDragging && !cropState.isResizing) return;

        const cropBox = document.getElementById('cropBox');
        if (!cropBox) return;

        const deltaX = e.clientX - cropState.dragStart.x;
        const deltaY = e.clientY - cropState.dragStart.y;

        if (cropState.isDragging) {
          moveCropBox(cropBox, deltaX, deltaY);
        } else if (cropState.isResizing) {
          resizeCropBox(cropBox, deltaX, deltaY, cropState.resizeHandle);
        }

        cropState.dragStart = { x: e.clientX, y: e.clientY };
        e.preventDefault();
      }

      function handleCropDragTouch(e) {
        if (!cropState.isDragging && !cropState.isResizing) return;

        const touch = e.touches[0];
        const cropBox = document.getElementById('cropBox');
        if (!cropBox) return;

        const deltaX = touch.clientX - cropState.dragStart.x;
        const deltaY = touch.clientY - cropState.dragStart.y;

        if (cropState.isDragging) {
          moveCropBox(cropBox, deltaX, deltaY);
        } else if (cropState.isResizing) {
          resizeCropBox(cropBox, deltaX, deltaY, cropState.resizeHandle);
        }

        cropState.dragStart = { x: touch.clientX, y: touch.clientY };
        e.preventDefault();
      }

      function endCropDrag() {
        cropState.isDragging = false;
        cropState.isResizing = false;
        cropState.resizeHandle = null;
      }

      function moveCropBox(cropBox, deltaX, deltaY) {
        const currentLeft = parseInt(cropBox.style.left) || 0;
        const currentTop = parseInt(cropBox.style.top) || 0;
        const boxWidth = parseInt(cropBox.style.width) || 0;
        const boxHeight = parseInt(cropBox.style.height) || 0;

        // Calculate new position with bounds checking
        let newLeft = currentLeft + deltaX;
        let newTop = currentTop + deltaY;

        // Keep within image bounds
        newLeft = Math.max(cropState.imageRect.left, Math.min(newLeft, cropState.imageRect.left + cropState.imageRect.width - boxWidth));
        newTop = Math.max(cropState.imageRect.top, Math.min(newTop, cropState.imageRect.top + cropState.imageRect.height - boxHeight));

        cropBox.style.left = newLeft + 'px';
        cropBox.style.top = newTop + 'px';
      }

      function startCropResize(e, handle) {
        cropState.isResizing = true;
        cropState.resizeHandle = handle;
        cropState.dragStart = { x: e.clientX, y: e.clientY };
        e.stopPropagation();
        e.preventDefault();
      }

      function resizeCropBox(cropBox, deltaX, deltaY, handle) {
        const minSize = 50;
        const currentLeft = parseInt(cropBox.style.left) || 0;
        const currentTop = parseInt(cropBox.style.top) || 0;
        const currentWidth = parseInt(cropBox.style.width) || 0;
        const currentHeight = parseInt(cropBox.style.height) || 0;

        let newLeft = currentLeft;
        let newTop = currentTop;
        let newWidth = currentWidth;
        let newHeight = currentHeight;

        // Handle different resize directions
        switch (handle) {
          case 'nw':
            newLeft = currentLeft + deltaX;
            newTop = currentTop + deltaY;
            newWidth = currentWidth - deltaX;
            newHeight = currentHeight - deltaY;
            break;
          case 'n':
            newTop = currentTop + deltaY;
            newHeight = currentHeight - deltaY;
            break;
          case 'ne':
            newTop = currentTop + deltaY;
            newWidth = currentWidth + deltaX;
            newHeight = currentHeight - deltaY;
            break;
          case 'e':
            newWidth = currentWidth + deltaX;
            break;
          case 'se':
            newWidth = currentWidth + deltaX;
            newHeight = currentHeight + deltaY;
            break;
          case 's':
            newHeight = currentHeight + deltaY;
            break;
          case 'sw':
            newLeft = currentLeft + deltaX;
            newWidth = currentWidth - deltaX;
            newHeight = currentHeight + deltaY;
            break;
          case 'w':
            newLeft = currentLeft + deltaX;
            newWidth = currentWidth - deltaX;
            break;
        }

        // Apply minimum size constraints
        if (newWidth < minSize) {
          if (handle.includes('w')) newLeft = currentLeft + currentWidth - minSize;
          newWidth = minSize;
        }
        if (newHeight < minSize) {
          if (handle.includes('n')) newTop = currentTop + currentHeight - minSize;
          newHeight = minSize;
        }

        // Keep within image bounds
        if (newLeft < cropState.imageRect.left) {
          newWidth -= (cropState.imageRect.left - newLeft);
          newLeft = cropState.imageRect.left;
        }
        if (newTop < cropState.imageRect.top) {
          newHeight -= (cropState.imageRect.top - newTop);
          newTop = cropState.imageRect.top;
        }
        if (newLeft + newWidth > cropState.imageRect.left + cropState.imageRect.width) {
          newWidth = cropState.imageRect.left + cropState.imageRect.width - newLeft;
        }
        if (newTop + newHeight > cropState.imageRect.top + cropState.imageRect.height) {
          newHeight = cropState.imageRect.top + cropState.imageRect.height - newTop;
        }

        // Apply the new dimensions
        cropBox.style.left = newLeft + 'px';
        cropBox.style.top = newTop + 'px';
        cropBox.style.width = newWidth + 'px';
        cropBox.style.height = newHeight + 'px';
      }

      function resetCropSelection() {
        const cropBox = document.getElementById('cropBox');

        // Reset to 80% of image, centered
        const cropWidth = cropState.imageRect.width * 0.8;
        const cropHeight = cropState.imageRect.height * 0.8;
        const cropLeft = cropState.imageRect.left + (cropState.imageRect.width - cropWidth) / 2;
        const cropTop = cropState.imageRect.top + (cropState.imageRect.height - cropHeight) / 2;

        cropBox.style.left = cropLeft + 'px';
        cropBox.style.top = cropTop + 'px';
        cropBox.style.width = cropWidth + 'px';
        cropBox.style.height = cropHeight + 'px';
      }

      function confirmCrop() {
        const cropBox = document.getElementById('cropBox');
        const cropImage = document.getElementById('cropImage');

        // Get crop dimensions relative to the actual image
        const cropLeft = parseInt(cropBox.style.left) - cropState.imageRect.left;
        const cropTop = parseInt(cropBox.style.top) - cropState.imageRect.top;
        const cropWidth = parseInt(cropBox.style.width);
        const cropHeight = parseInt(cropBox.style.height);

        // Validate crop size
        if (cropWidth < 50 || cropHeight < 50) {
          showAlert('Crop area is too small. Please select a larger area (minimum 50x50 pixels).');
          return;
        }

        // Calculate crop ratios
        const scaleX = cropImage.naturalWidth / cropState.imageRect.width;
        const scaleY = cropImage.naturalHeight / cropState.imageRect.height;

        workflowState.cropData = {
          x: cropLeft * scaleX,
          y: cropTop * scaleY,
          width: cropWidth * scaleX,
          height: cropHeight * scaleY,
          originalWidth: cropImage.naturalWidth,
          originalHeight: cropImage.naturalHeight
        };

        // Create cropped image
        createCroppedImage();
      }

      function createCroppedImage() {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const cropImage = document.getElementById('cropImage');

        canvas.width = workflowState.cropData.width;
        canvas.height = workflowState.cropData.height;

        // Draw the cropped portion
        context.drawImage(
          cropImage,
          workflowState.cropData.x,
          workflowState.cropData.y,
          workflowState.cropData.width,
          workflowState.cropData.height,
          0,
          0,
          canvas.width,
          canvas.height
        );

        // Convert to blob
        canvas.toBlob((blob) => {
          if (blob) {
            workflowState.croppedImage = blob;
            workflowState.currentStep = 'processing';

            showAlert('Image cropped successfully', 'success');
            processImage(blob);
          } else {
            showAlert('Failed to create cropped image. Please try again.');
          }
        }, 'image/jpeg', 0.9);
      }

      function cancelCrop() {
        // Clean up object URL
        const cropImage = document.getElementById('cropImage');
        if (cropImage.src.startsWith('blob:')) {
          URL.revokeObjectURL(cropImage.src);
        }

        resetWorkflow();
      }

      // Text Input Processing Function
      async function processTextInput() {
        const textInput = document.getElementById('textInput');
        const text = textInput ? textInput.value.trim() : '';

        if (!text) {
          showAlert('Please enter some Japanese text to analyze.');
          return;
        }

        console.log('Processing text input:', text);

        // Update workflow state
        workflowState.currentStep = 'processing';
        workflowState.isLoading = true;
        workflowState.selectedImage = null; // No image for text input
        workflowState.croppedImage = null;

        // Show processing interface
        showInterface('processingInterface');

        // Update progress
        updateProcessingProgress(30, 'Processing text input...');

        try {
          // Translate the text using the existing translation function
          updateProcessingProgress(60, 'Translating text...');

          let translationData = null;
          if (text && text.trim()) {
            try {
              translationData = await translateExtractedText(text, 'japanese');
              console.log('Translation data:', translationData);
            } catch (e) {
              console.error('Translation failed:', e);
              // Show a user-friendly message if translation fails
              translationData = {
                romanized: 'Translation service unavailable',
                translated: 'Translation service unavailable'
              };
            }
          }

          updateProcessingProgress(90, 'Analyzing kanji characters...');

          // Store result
          workflowState.ocrResult = {
            extractedText: text,
            translationData: translationData,
            source: 'text_input'
          };

          // Show results
          workflowState.currentStep = 'results';
          workflowState.isLoading = false;
          showInterface('resultsInterface');

          // Display results
          displayOCRResults(text, translationData);

          updateProcessingProgress(100, 'Complete!');
          showAlert('Text analysis completed successfully!', 'success');

        } catch (err) {
          console.error('Text processing error:', err);
          workflowState.error = err.message;
          workflowState.currentStep = 'error';
          workflowState.isLoading = false;

          showAlert('Failed to process the text. Please try again.');
          resetWorkflow();
        }
      }

      // OCR Processing Functions
      async function processImage(imageBlob = null) {
        console.log('processImage function called with workflow');

        // Use the cropped image blob or fall back to selected image
        const imageToProcess = imageBlob || workflowState.croppedImage || workflowState.selectedImage;

        if (!imageToProcess) {
          showAlert("No image available for processing!");
          return;
        }

        // Update workflow state
        workflowState.currentStep = 'processing';
        workflowState.isLoading = true;

        // Show processing interface
        showInterface('processingInterface');

        // Update progress
        updateProcessingProgress(10, 'Uploading image...');

        try {
          // First upload the image to our server
          const formData = new FormData();
          formData.append('image', imageToProcess);

          const apiUrl = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:5000/upload-image'
            : '/upload-image';

          console.log('Uploading image to:', apiUrl);
          const uploadResponse = await fetch(apiUrl, {
            method: 'POST',
            body: formData
          });

          updateProcessingProgress(30, 'Image uploaded, starting OCR...');

          const uploadData = await uploadResponse.json();
          if (uploadData.error) {
            console.error('Upload error:', uploadData.error);
            throw new Error(uploadData.error);
          }
          console.log('Upload successful:', uploadData);

          // OCR using Tesseract
          updateProcessingProgress(50, 'Extracting text with AI...');
          const { data: { text } } = await Tesseract.recognize(imageToProcess, 'jpn');
          console.log('Extracted text:', text);

          updateProcessingProgress(70, 'Translating text...');

          // Translate the extracted text using the existing translation function
          let translationData = null;
          if (text && text.trim()) {
            try {
              translationData = await translateExtractedText(text, 'japanese');
              console.log('Translation data:', translationData);
            } catch (e) {
              console.error('Translation failed:', e);
              // Show a user-friendly message if translation fails
              translationData = {
                romanized: 'Translation service unavailable',
                translated: 'Translation service unavailable'
              };
            }
          }

          updateProcessingProgress(90, 'Analyzing kanji characters...');

          // Store OCR result
          workflowState.ocrResult = {
            extractedText: text,
            translationData: translationData
          };

          // Show results
          workflowState.currentStep = 'results';
          workflowState.isLoading = false;
          showInterface('resultsInterface');

          // Display results
          displayOCRResults(text, translationData);

          updateProcessingProgress(100, 'Complete!');
          showAlert('Text extraction completed successfully!', 'success');

        } catch (err) {
          console.error('OCR Error:', err);
          workflowState.error = err.message;
          workflowState.currentStep = 'error';
          workflowState.isLoading = false;

          showAlert('Failed to process the image. Please try again with a clearer image.');
          resetWorkflow();
        }
      }

      // Update Processing Progress
      function updateProcessingProgress(percentage, status) {
        const progressBar = document.getElementById('processingProgress');
        const statusText = document.getElementById('processingStatus');

        if (progressBar) {
          progressBar.style.width = percentage + '%';
        }

        if (statusText) {
          statusText.textContent = status;
        }
      }

      // Display OCR Results
      function displayOCRResults(text, translationData) {
        const output = document.getElementById('output');
        if (!output) return;

        // Show extracted text with translation
        let translationHtml = '';
        if (translationData) {
          translationHtml = `
            <div class="mt-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 shadow-sm">
              <h4 class="text-lg font-bold text-blue-800 mb-4 flex items-center">
                <i class="fas fa-language mr-3 text-xl"></i>
                Full Sentence Translation
              </h4>
              <div class="space-y-4">
                <div class="bg-white rounded-lg p-4 shadow-sm">
                  <span class="text-sm text-blue-600 font-semibold uppercase tracking-wide">Romaji:</span>
                  <p class="text-lg text-blue-900 font-medium mt-1">${translationData.romanized || 'N/A'}</p>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm">
                  <span class="text-sm text-blue-600 font-semibold uppercase tracking-wide">English:</span>
                  <p class="text-lg text-blue-900 font-medium mt-1">${translationData.translated || 'N/A'}</p>
                </div>
              </div>
            </div>
          `;
        }

        output.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 mb-6">
            <div class="flex items-center mb-4">
              <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-3 rounded-xl mr-4">
                <i class="fas fa-file-text text-green-600 text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-gray-900">Japanese Text Analysis</h3>
                <p class="text-sm text-gray-600">
                  ${workflowState.ocrResult?.source === 'text_input' ?
            'Text input with full translation and analysis' :
            'Extracted from image with full translation'}
                </p>
              </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-6 kanji-font">
              <div class="mb-4">
                <span class="text-sm text-gray-600 font-semibold uppercase tracking-wide">Original Japanese:</span>
                <p class="text-gray-800 text-2xl leading-relaxed mt-2 font-medium">${text || 'No text extracted'}</p>
              </div>
              ${translationHtml}
            </div>
          </div>
        `;

        // Extract unique Kanji
        const kanjis = [...new Set(text.match(/[\u4e00-\u9faf]/g))];
        if (!kanjis || kanjis.length === 0) {
          output.innerHTML += `
            <div class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8">
              <div class="text-left">
                <div class="flex items-center mb-6">
                  <div class="w-20 h-20 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-search text-3xl text-yellow-600"></i>
                  </div>
                  <div>
                    <h3 class="text-2xl font-semibold text-gray-900 mb-3">No Kanji Found</h3>
                    <p class="text-gray-600 text-lg">The extracted text doesn't contain any Japanese kanji characters, but the full sentence translation above shows the meaning.</p>
                  </div>
                </div>
              </div>
            </div>
          `;
          return;
        }

        // Show kanji count and start processing
        output.innerHTML += `
          <div class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center">
                <div class="bg-gradient-to-r from-purple-100 to-violet-100 p-3 rounded-xl mr-4">
                  <i class="fas fa-search text-purple-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-semibold text-gray-900">Individual Kanji Analysis</h3>
                  <p class="text-sm text-gray-600">Detailed breakdown of each kanji character</p>
                </div>
              </div>
              <span class="bg-gradient-to-r from-purple-100 to-violet-100 text-purple-800 px-4 py-2 rounded-full text-sm font-semibold">
                ${kanjis.length} character${kanjis.length !== 1 ? 's' : ''} found
              </span>
            </div>
            <div class="grid grid-cols-1 gap-4" id="kanjiResults">
              <!-- Kanji cards will be inserted here -->
            </div>
          </div>
        `;

        // Fetch and display Kanji details
        displayKanjiAnalysis(kanjis);
      }

      // Display Kanji Analysis
      async function displayKanjiAnalysis(kanjis) {
        const kanjiResults = document.getElementById('kanjiResults');
        if (!kanjiResults) return;

        // Fetch Kanji details
        for (const kanji of kanjis) {
          try {
            const res = await fetch(`https://kanjiapi.dev/v1/kanji/${encodeURIComponent(kanji)}`);
            if (!res.ok) continue;
            const data = await res.json();

            // Convert readings to Romaji
            const onRomaji = data.on_readings.map(r => window.wanakana.toRomaji(r));
            const kunRomaji = data.kun_readings.map(r => window.wanakana.toRomaji(r));

            const gradeDisplay = data.grade ? `Grade ${data.grade}` : 'Advanced';
            const gradeColor = data.grade && data.grade <= 6 ? 'text-green-600 bg-green-100' : 'text-purple-600 bg-purple-100';

            kanjiResults.innerHTML += `
              <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl p-6 border border-slate-200 hover:shadow-lg transition-all duration-200">
                <div class="flex items-start justify-between mb-4">
                  <div class="kanji-font text-4xl font-bold text-gray-900 bg-white p-3 rounded-xl shadow-sm">
                    ${data.kanji}
                  </div>
                  <div class="flex space-x-2">
                    <span class="${gradeColor} px-2 py-1 rounded-full text-xs font-medium">
                      ${gradeDisplay}
                    </span>
                    <span class="text-slate-600 bg-slate-100 px-2 py-1 rounded-full text-xs font-medium">
                      ${data.stroke_count} strokes
                    </span>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <div class="bg-white rounded-lg p-3">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-globe-americas mr-2 text-blue-500"></i>
                      Meanings
                    </h4>
                    <p class="text-gray-800 font-medium">${data.meanings.join(', ')}</p>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-white rounded-lg p-3">
                      <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-yin-yang mr-2 text-red-500"></i>
                        On'yomi
                      </h4>
                      <p class="kanji-font text-gray-800 mb-1">${data.on_readings.join(', ') || "N/A"}</p>
                      <p class="text-sm text-gray-600 italic">${onRomaji.join(', ') || "N/A"}</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-3">
                      <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-yin-yang mr-2 text-indigo-500"></i>
                        Kun'yomi
                      </h4>
                      <p class="kanji-font text-gray-800 mb-1">${data.kun_readings.join(', ') || "N/A"}</p>
                      <p class="text-sm text-gray-600 italic">${kunRomaji.join(', ') || "N/A"}</p>
                    </div>
                  </div>
                </div>
              </div>
            `;
          } catch (err) {
            console.error('Error processing kanji:', kanji, err);
          }
        }
      }

      // Initialize Workflow Event Listeners
      function initializeWorkflowEventListeners() {
        console.log('Initializing KanjiOCR workflow functionality');

        // Initialize UI elements
        initializeUIElements();

        // Image selection events
        const imageInput = document.getElementById('imageInput');
        const cameraBtn = document.getElementById('cameraBtn');

        if (imageInput) {
          imageInput.addEventListener('change', handleFileSelect);
        }

        if (cameraBtn) {
          cameraBtn.addEventListener('click', initializeCamera);
        }

        // Camera interface events
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const cancelCameraBtn = document.getElementById('cancelCameraBtn');

        if (capturePhotoBtn) {
          capturePhotoBtn.addEventListener('click', capturePhoto);
        }

        if (cancelCameraBtn) {
          cancelCameraBtn.addEventListener('click', cancelCamera);
        }

        // Cropping interface events
        const confirmCropBtn = document.getElementById('confirmCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const resetCropBtn = document.getElementById('resetCropBtn');

        if (confirmCropBtn) {
          confirmCropBtn.addEventListener('click', confirmCrop);
        }

        if (cancelCropBtn) {
          cancelCropBtn.addEventListener('click', cancelCrop);
        }

        if (resetCropBtn) {
          resetCropBtn.addEventListener('click', resetCropSelection);
        }

        // New image button
        const newImageBtn = document.getElementById('newImageBtn');
        if (newImageBtn) {
          newImageBtn.addEventListener('click', resetWorkflow);
        }

        // Text input processing
        const processTextBtn = document.getElementById('processTextBtn');
        if (processTextBtn) {
          processTextBtn.addEventListener('click', processTextInput);
        }

        // Allow Enter key in text area to process
        const textInput = document.getElementById('textInput');
        if (textInput) {
          textInput.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'Enter') {
              processTextInput();
            }
          });
        }

        // Initialize workflow to show image selection
        resetWorkflow();
      }

      // Initialize event listeners when DOM is loaded
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize KanjiOCR workflow functionality
        initializeWorkflowEventListeners();
      });

      // Show Facts section
      function showFacts() {
        if (homeSection) homeSection.classList.add('hidden');
        createSection.classList.add('hidden');
        translatorSection.classList.add('hidden');
        pronunciationSection.classList.add('hidden');
        if (phrasesSection) phrasesSection.classList.add('hidden');
        const kanjiOCRSection = document.getElementById('kanjiOCRSection');
        if (kanjiOCRSection) kanjiOCRSection.classList.add('hidden');
        const factsSection = document.getElementById('factsSection');
        if (factsSection) factsSection.classList.remove('hidden');
        hideFlashcardUI();
        setNavActive('facts');
      }

      // Facts filtering functionality
      function initFactsFiltering() {
        const allFactsBtn = document.getElementById('allFactsBtn');
        const geographyBtn = document.getElementById('geographyBtn');
        const dailyLifeBtn = document.getElementById('dailyLifeBtn');
        const cultureBtn = document.getElementById('cultureBtn');
        const traditionsBtn = document.getElementById('traditionsBtn');
        const factCards = document.querySelectorAll('.fact-card');

        function filterFacts(category) {
          factCards.forEach(card => {
            if (category === 'all' || card.classList.contains(category)) {
              card.style.display = 'block';
              card.style.animation = 'fadeInUp 0.5s ease-out';
            } else {
              card.style.display = 'none';
            }
          });

          // Update filter button styles
          const filterButtons = [allFactsBtn, geographyBtn, dailyLifeBtn, cultureBtn, traditionsBtn];
          filterButtons.forEach(btn => {
            if (btn) {
              btn.className = 'px-6 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors';
            }
          });

          // Highlight active filter
          const activeBtn = category === 'all' ? allFactsBtn :
            category === 'geography' ? geographyBtn :
              category === 'daily-life' ? dailyLifeBtn :
                category === 'culture' ? cultureBtn :
                  category === 'traditions' ? traditionsBtn : null;

          if (activeBtn) {
            activeBtn.className = 'px-6 py-2 bg-indigo-600 text-white rounded-full font-medium hover:bg-indigo-700 transition-colors';
          }
        }

        // Event listeners for filter buttons
        if (allFactsBtn) {
          allFactsBtn.addEventListener('click', () => filterFacts('all'));
        }
        if (geographyBtn) {
          geographyBtn.addEventListener('click', () => filterFacts('geography'));
        }
        if (dailyLifeBtn) {
          dailyLifeBtn.addEventListener('click', () => filterFacts('daily-life'));
        }
        if (cultureBtn) {
          cultureBtn.addEventListener('click', () => filterFacts('culture'));
        }
        if (traditionsBtn) {
          traditionsBtn.addEventListener('click', () => filterFacts('traditions'));
        }

        // Initialize with all facts visible
        filterFacts('all');
      }

      // Event listeners for facts
      const btnNavFacts = document.getElementById('btnNavFacts');
      if (btnNavFacts) {
        btnNavFacts.addEventListener('click', () => {
          showFacts();
          // Initialize facts filtering when Facts section is shown
          setTimeout(initFactsFiltering, 100);
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', function () {
          renderPhrases();
        });
      }

      if (showAllBtn) {
        showAllBtn.addEventListener('click', function () {
          currentFilter = 'all';
          setFilterActive(showAllBtn);
          renderPhrases();
        });
      }

      if (showPhrasesBtn) {
        showPhrasesBtn.addEventListener('click', function () {
          currentFilter = 'phrases';
          setFilterActive(showPhrasesBtn);
          renderPhrases();
        });
      }

      if (showWordsBtn) {
        showWordsBtn.addEventListener('click', function () {
          currentFilter = 'words';
          setFilterActive(showWordsBtn);
          renderPhrases();
        });
      }

      // Update the setNavActive function to include phrases
      function setNavActive(target) {
        // Reset all
        if (btnNavHome) {
          btnNavHome.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavHome.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavFlashcards) {
          btnNavFlashcards.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavFlashcards.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavTranslator) {
          btnNavTranslator.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavTranslator.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavPronunciation) {
          btnNavPronunciation.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavPronunciation.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (btnNavPhrases) {
          btnNavPhrases.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavPhrases.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        const btnNavFacts = document.getElementById('btnNavFacts');
        if (btnNavFacts) {
          btnNavFacts.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavFacts.classList.add('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }

        if (target === 'home' && btnNavHome) {
          btnNavHome.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavHome.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (target === 'flashcards' && btnNavFlashcards) {
          btnNavFlashcards.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavFlashcards.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (target === 'translator' && btnNavTranslator) {
          btnNavTranslator.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavTranslator.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (target === 'pronunciation' && btnNavPronunciation) {
          btnNavPronunciation.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavPronunciation.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (target === 'phrases' && btnNavPhrases) {
          btnNavPhrases.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
          btnNavPhrases.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
        }
        if (target === 'facts') {
          const btnNavFacts = document.getElementById('btnNavFacts');
          if (btnNavFacts) {
            btnNavFacts.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
            btnNavFacts.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-100');
          }
        }
      }

      // Initial state: Home visible
      showHome();
    })();
  </script>

  <!-- Chatling Chatbot -->
  <script async data-id="7958299315" id="chtl-script" type="text/javascript"
    src="https://chatling.ai/js/embed.js"></script>
</body>

</html><s cript async data-id="7958299315" id="chtl-script" type="text/javascript"
  src="https://chatling.ai/js/embed.js"></script>
  </body>

  </html>